<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<title>{% block title %}Those Days{% endblock %}</title>
		<meta name="description" content="{% block description %}{% endblock %}"> 
		<meta http-equiv="content-type" content="text/html; charset=utf-8"/>
		<meta http-equiv="pragma" content="no-cache" />
		<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
		<link href='https://fonts.googleapis.com/css?family=Open+Sans:300,400,700' rel='stylesheet' type='text/css'>
		<link href='/static/css/default.css' rel='stylesheet' type='text/css'>
		<style type="text/css">
		#main { 
			max-width:700px; 
			min-width:350px;
			margin: 0 auto;
		}
		
		#loading { 
			text-align: center; 
		}
		
		.buttons-main {
			position:relative;
		}
		
		.buttons-main .input-text {
			margin-right: 165px;
			max-width: 400px;
			padding-left:30px;
		}
		
		.buttons-main .input-text input[type=text] {
			width:100%;
			box-sizing:border-box;
			font-size: 14px;
		}
		
		.buttons-main .input-text .icon-search {
			width: 20px;
			height: 20px;
			position: absolute;
			top: 9px;
			left: 7px;
			fill: #dc2528;
		}
		
		.buttons-right {
			position:absolute;
			right:2px;
			top:2px;
		}
		
		#events {
			margin-top:40px;
			text-align:left;
		}
		
		.events:after {
			content:" ";
			clear:both;
			display:block;
		}
		
		#events .year {
			margin-bottom:20px;
		}
		
		#events .year .header {
			text-align: center;
			padding-bottom: 30px;
		}
		
		#events .year .header .year-num {
			color: #fff;
			background: #e63d35;
			border-radius: 2px;
			padding: 5px 10px;
			display: inline-block;
			font-size: 24px;
		}
		
		#events .event {
			position:relative;
			background-color:#ccc;
			background-size:cover;
			float:left;
			width:170px;
			height:170px;
			margin-right:3px;
			margin-bottom:3px;
		}
		
		#events .event .date,
		.div-photo .date {
			position:absolute;
			left:10px;
			bottom:8px;
			color:#fff;
			text-shadow: 0px 0px 1px #444;
		}
		
		#events .event .date .day,
		.div-photo .date .day {
			font-size:24px;
			text-align:center;
		}
		
		.events-place {
			width:400px;
			max-height:400px;
			overflow-y:scroll;
		}
		
		.events-place .header {
			padding:20px 10px;
		}
		
		.events-place .event {
			padding: 5px 0px;
		}
		
		.events-place .event:after {
			content:" ";
			display:block;
			clear:both;
		}
		
		.events-place .event div.photo {
			float:left;
			width:100px;
			height:100px;
			background-size:cover;
			margin:0px 5px;
			border-radius:3px;
		}
		
		.events-place .event .date {
			float:right;
			margin-right: 10px;
		}
		
		.events-place .event .date .day {
			font-size:24px;
			text-align:center;
		}
		
		.events-place .event div.detail {
			padding:0 100px 0 100px;
		}
		
		.events-place .event .desc {
			padding: 10px 5px;
			height:60px;
			line-height:18px;
			overflow:hidden;
		}
		
		.event-single {
			width:300px;
		}
		
		.event-single .div-photo {
			position:relative;
		}
		
		.event-single img.photo {
			width:100%;
		}
		
		.event-single .desc {
			padding:20px 10px;;
		}
		
		.tag {
			background-color: #efefef;
			border: 1px solid #ccc;
			color: #777;
			border-radius: 9px;
			padding: 2px 8px;
			margin:2px;
			display: inline-block;
			cursor: pointer;
		}
		
		.tag+.tag {
			margin-left:5px;
		}
		
		.tag.active {
			background-color: #3a91f4;
			border-color: #284c71;
			color: #fff;
		}
		
		.dlg {
			position:fixed;
			top:0;
			bottom:0;
			left:0;
			right:0;
			background-color:rgba(255, 255, 255, 0.5);
			overflow-y:scroll;
		}
		
		.dlg #map_canvas {
			max-width:700px;
			min-width: 350px;
			height: 100%;
			margin: 0 auto;
		}
		
		.dlg .dlg-event-body {
			max-width:500px;
			min-width: 350px;
			box-sizing: border-box;
			margin: 30px auto;
			padding:10px;
			background-color:#fff;
			border:1px solid #ccc;
			position:relative;
		}
		
		.dlg .dlg-event-body .dlg-event-desc {
			padding:10px 0;
		}
		
		.dlg .dlg-btn-edit {
			color:#999;
			font-size:10px;
			margin-left:5px;
			cursor:pointer;
		}
		
		.dlg .dlg-btn-edit:hover {
			text-decoration:underline;
		}
		
		.dlg .dlg-event-body .dlg-event-desc .dlg-btn-edit {
			display:none;
		}
		
		.dlg .dlg-event-body .dlg-event-desc:hover .dlg-btn-edit {
			display:inline-block;
		}
		
		.dlg .dlg-event-body .dlg-buttons:after,
		.dlg .dlg-event-people:after {
			clear:both;
			content:" ";
			display:block;
		}
		
		.dlg .dlg-event-body .buttons-tools {
			float:left;
		}
		
		.dlg .dlg-event-body .buttons-act {
			text-align:right;
		}
		
		.dlg .dlg-event-body .btn-icon {
			width:30px;
			height:30px;
			display: inline-block;
			vertical-align: middle;
			margin-right: 18px;
			position:relative;
		}
		
		.dlg .dlg-event-body .btn-icon>svg,
		.dlg .dlg-event-body .btn-icon .icon-photo {
			fill:#ccc;
			opacity:0.7;
		}
		
		.dlg .dlg-event-body .btn-icon svg:hover {
			opacity:1;
		}
		
		.dlg .dlg-event-body .btn-icon.active>svg,
		.dlg .dlg-event-body .btn-icon.active .icon-photo {
			fill:#dd4b39;
			opacity:1;
		}
		
		.dlg .dlg-event-body .btn-icon svg {
			display:inline-block;
		}
		
		
		.dlg .dlg-event-body .btn-icon .icon-photo {
			width: 28px;
			height: 28px;
		}
		
		.dlg .dlg-event-body .btn-icon .icon-people {
			width: 24px;
			height: 24px;
			margin-top: 2px;
			margin-left: 7px;
		}
		
		.dlg .dlg-event-body .btn-icon .icon-marker {
			width: 30px;
			height: 30px;
		}
		
		.dlg .dlg-event-body .btn-icon .icon-tag {
			width: 20px;
			height: 20px;
			padding-top: 5px;
			padding-left: 2px;
		}
		
		.dlg .dlg-event-photo {
			background-color:#f5f5f5;
			min-height:200px;
			max-height:400px;
			position:relative;
			text-align:center;
			font-size:0; /* avoid padding-bottom for img */
		}
		
		.dlg .dlg-event-photo img {
			display:inline;
			max-height:100%; 
			max-width:100%;
		}
		
		.dlg .dlg-event-place {
			background-color:#ccc;
			position:relative;
			text-align:center;
		}
		
		.dlg .dlg-event-place img {
			display:block;
			width:100%;
			min-height:150px;
		}
		
		.dlg .dlg-event-people {
			padding: 10px 0px;	
		}
		
		.dlg .dlg-event-people .user {
			float:left;
			width:50px;
			height:50px;
			margin:0px 2px 2px 0px;
			position:relative;
		}
		
		.dlg .dlg-event-people .user img {
			width:100%;
			height:100%;
			border-radius:2px;
		}
		
		.dlg .dlg-event-body .progressbar {
			display:inline-block;
			position: absolute;
			top:50%;
			left: 30px;
			right: 30px;
		}
		
		.dlg .dlg-event-body .dlg-event-loading {
			position:absolute;
			top:50%;
			left:0;
			right:0;
			text-align:center;
		}
		
		.dlg .dlg-buttons {
			padding-top:10px;
		}
	
		.progressbar {
			background-color: #e5e5e5;
			height: 4px;
		}
	
		.progressbar .progress {
			height: 2px;
			border: 1px solid #edba3d;
			background-color: #f8bd34;
			width:0%;
			position: absolute;
		}
		
		.menu-people {
			right:-115px;
			width:230px;
		}
		
		.menu-people .people:after {
			content:" ";
			display:block;
			clear:both;
		}
		
		.menu-people .user {
			float:left;
			width:50px;
			height:50px;
			margin:0px 2px 2px 0px;
			position:relative;
		}
		
		.menu-people .user img {
			width:100%;
			height:100%;
		}
		
		.menu-people .user .mask-check {
			position:absolute;
			left:0;
			right:0;
			top:0;
			bottom:0;
			background-color:rgba(0, 0, 0, 0.3);
			display:none;
			text-align:center;
		}
		
		.menu-people .user:hover .mask-check,
		.menu-people .user.checked .mask-check {
			display:block;
		}
		
		.menu-people .user.checked .mask-check svg {
			fill:#449c2f;
		}
		
		.menu-people .mask-check svg {
			width: 24px;
			height: 24px;
			margin-top: 12px;
		}
		
		.menu-people .buttons {
			text-align:right;
		}
		
		.menu-tags {
			width:250px;
			right:-120px;
		}
		
		.menu-tags .input-text input {
			border-width: 0px;
			width: 100%;
			box-sizing: border-box;
			padding-right: 30px;
			margin-top: 5px;
		}
		
		.menu-tags .input-text .btn-add {
			position: absolute;
			right: 6px;
			top: 8px;
		}
		
		.menu-tags .input-text .btn-add svg {
			width: 20px;
			height: 20px;
			stroke: #ccc;
			fill: none;
		}
		
		.menu-tags .input-text .btn-add.active svg {
			stroke: #449c2f;
		}
		
		.autocomplete-suggestions { border: 1px solid #999; background: #FFF; overflow: auto; }
		.autocomplete-suggestion { padding: 3px 5px; white-space: nowrap; overflow: hidden; }
		.autocomplete-suggestion img { width:40px; height:40px; float:left; border-radius:2px;}
		.autocomplete-suggestion .autocomplete-suggestion-info { margin-left:50px; margin-top: 12px;}
		.autocomplete-suggestion:after { content:" "; display:block; clear:both;}
		.autocomplete-selected { background: #F0F0F0; }
		.autocomplete-suggestions strong { font-weight: normal; color: #3399FF; }
		
		</style>
		<script type="text/javascript" src="/static/js/assets.js"></script>
		<script type="text/javascript" src="/static/js/date.format.js"></script>
		<script type="text/javascript" src="//maps.googleapis.com/maps/api/js?sensor=false&libraries=places"></script>
		<script type="text/javascript" src="/static/js/markerclusterer.js"></script>
		<script type="text/javascript" src="/static/js/infobox.js"></script>
		<script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/2.1.0/jquery.min.js"></script>
		<script type="text/javascript" src="/static/js/jquery.autocomplete.js"></script>
		<script type="text/javascript" src="/static/js/core.js"></script>
		<script type="text/javascript">
		
		core.Map = {
			createMarker:function(opts) {
				var marker = new google.maps.Marker(opts);
				google.maps.event.addListener(marker, 'click', function() {
					var e = marker.event;
					var v = $("<div class='event-single'></div>");
					if (e.photo) {
						var date = strptime(e.event_time, core.timezone);
						var divPhoto = $("<div class='div-photo'><img class='photo' src='"
							 					+ e.photo.thumb_url + "400' /></div>").appendTo(v);
						var h = 300.0 * e.photo.height / e.photo.width;
						divPhoto.css({ height: h + "px" });
						divPhoto.append("<div class='date'><div class='month'>" + date.format("mmm").toUpperCase() + "</div>" + 
																"<div class='day'>" + date.format("d") + "</div></div>")
					}
					if (e.description) {
						v.append("<div class='desc'>" + e.description + "</div>")
					}
					var wrap = $("<div>");
					wrap.append(v);
					core.Map.infobox.setContent(wrap.html());
					core.Map.infobox.open(core._map, marker.getPosition());
				});
				return marker;
			},
			getBounds:function(markers) {
				var bounds = new google.maps.LatLngBounds();
				for(var i in markers) {
					bounds.extend(markers[i].getPosition());
				}
				return bounds;
			},
			markers:[],
			infobox:new InfoBox({ pixelOffset:new google.maps.Size(0, -30) })
		}
		
		core.getMap = function(canvas, opts) {
			if (core._map) return core._map;
			var mapOptions = {
				center: opts.center,
				zoom: opts.zoom,
				mapTypeId: google.maps.MapTypeId.ROADMAP
			};
			var map = new google.maps.Map(canvas, mapOptions);
			core._map = map;
			var mc = new MarkerClusterer(map, null, { zoomOnClick:false });
			map.mc = mc;
			
		    google.maps.event.addListener(mc, 'clusterclick', function(cluster) {
				var div = $("<div class='events-place'>");
				var center = cluster.getCenter();
				div.append("<div class='header'>Near by " + center.lat() + "," + center.lng() + "</div>");
				var markers = cluster.getMarkers();
				for (var i in markers) {
					var e = markers[i].event;
					var v = $("<div class='event'></div>").appendTo(div);
					if (e.photo) {
						v.append("<div class='photo' style='background-image:url(" + e.photo.thumb_url + "300);'></div>")
					}
					var date = strptime(e.event_time, core.timezone);
					v.append("<div class='date'><div class='month'>" + date.format("mmm").toUpperCase() + "</div>" + 
									"<div class='day'>" + date.format("d") + "</div></div>")
					v.append("<div class='detail'><div class='desc'>"
						 					+ (e.description || "") + "</div></div>")
				}
				var wrap = $("<div>");
				wrap.append(div);
				core.Map.infobox.setContent(wrap.html());
				core.Map.infobox.open(map, center);
		    });
			return map;
		};
		
		core.Friend = {
			users:{},
			add:function(user) {
				core.Friend.users[user.id] = user;
			},
			lookup:function(id) {
				return core.Friend.users[id];
			}
		};
		
		core.Tag = {
			tags:{},
			add:function(tagname) {
				core.Tag.tags[tagname] = tagname;
			},
			lookup:function(id) {
				return core.Tag.tags[id];
			},
			update:function() {
				core.Tag.tags = {};
				core.api("/tag", "GET", function(res) {
					if (res) {
						for (var i in res) {
							core.Tag.add(res[i]);
						}
					}
				});
			}
		};
		
		core.Tag.update();
		
		core.api("/me/friends", "GET", function(res) {
			if (res) {
				for (var i in res) {
					core.Friend.add(res[i]);
				}
			}
		});
		
		core.Menu = {
			menus:{},
			add:function(view) {
				var menus = core.Menu.menus;
				var id = view.attr("menu-id");
				if (!menus[id]) {
					menus[id] = new Menu(view);
				}
				return menus[id];
			},
			lookup:function(id) {
				return core.Menu.menus[id];
			}
		};
		
		function Menu(view) {
			var me = this;
			this.view = view;
			this.view.on("show", function() {
				core.events.trigger(me, "show");
			});
		}
		
		function SearchBar(view) {
			var me = this;
			me.view = view;
			me.filters = me.view.find(".filters");
			me.input = me.view.find("#input-search");
			me.input.autocomplete({
				lookup:[],
				noCache: true,//TODO use cache
				triggerSelectOnValidInput: false,
			    onSelect: function (suggestion) {
					var type = suggestion.type;
					if (type == 'tag') {
						var tag = suggestion.data;
						me.filters.append("<span class='tag active filter' key='" + tag + "' type='tag'>" + tag + "</span>");
						var w = me.view.width() - me.filters.width() - parseInt(me.view.css("padding-left").replace("px", ""), 10);
						me.input.css({width:w + "px"});
						me.input.val("");
					} else if (type == 'user') {
						var user = suggestion.data;
						me.filters.append("<span class='tag active filter' key='" + user.id
							 						+ "' type='user'>" + user.name + "</span>");
					}
					
					me.input.val("");
					me.onFilterChanged();
			    },
				onCreateView: function(value, suggestions) {
					var html = "";
					for (var i in suggestions) {
						var suggestion = suggestions[i];
						var type = suggestion.type;
						if (type === 'user') {
							html += '<div class="autocomplete-suggestion" data-index="' + i + '">' + 
									'<img src="' + suggestion.data.profile_picture + '" />' + 
									'<div class="autocomplete-suggestion-info">With ' + $.Autocomplete.formatResult(suggestion, value) +
									'</div></div>';
						} else if (type === 'tag') {
							html += '<div class="autocomplete-suggestion" data-index="' + i + '">' + 
									'<div>' + $.Autocomplete.formatResult(suggestion, value) +
									'</div></div>';
						}
					}
					return html;
				}
			}).focus(function() {
				var lookup = [];
				var friends = core.Friend.users;
				for (var i in friends) {
					var user = friends[i];
					lookup.push({ value:user.name, data:user, type:'user' });
				}
				var tags = core.Tag.tags;
				for (var i in tags) {
					var tag = tags[i];
					lookup.push({ value:tag, data:tag, type:'tag' });
				}
				var opts = {'lookup':lookup};
				$(this).autocomplete('setOptions', opts);
			}).keydown(function(e) {
				if (e.which == 8 && $(this).val().trim() == "") {
					me.filters.find(".filter:last").remove();
					me.onFilterChanged();
				}
			});
		}
		
		SearchBar.prototype.getFilters = function() {
			var me = this;
			var filters = [];
			me.filters.find(".filter").each(function() {
				filters.push({ type:$(this).attr("type"), key:$(this).attr("key")});
			});
			return filters;
		};
		
		SearchBar.prototype.onFilterChanged = function() {
			var me = this;
			var w = me.view.width() - me.filters.width() - parseInt(me.view.css("padding-left").replace("px", ""), 10);
			me.input.css({width:w + "px"});
			
			core.events.trigger(this, "filter_change");
		};
		
		function Events(view, empty, loading, opts) {
			var me  = this;
			me.opts = opts;
			me.view = view;
			me.empty = empty;
			me.loading = loading;
			me.years = {};
			me.view.on("click", ".event", function() {
				if(me.opts.onItemClick) {
					me.opts.onItemClick($(this).attr("key"));
				}
			});
		}
		
		Events.prototype.getYear = function(year) {
			var me = this;
			if (!me.years[year]) {
				me.years[year] = new Year(this, year);
			}
			return me.years[year];
		};
		
		Events.prototype.addEvent = function(e) {
			var me = this;
			var event_time = strptime(e.event_time, core.timezone);
			var year = me.getYear(event_time.getFullYear());
			var eventsContainer = year.getEvents();
			var events = eventsContainer.find(".event");
			var view = me.inflateEvent(e);
			if (events.length == 0) {
				eventsContainer.append(view);
				me.notifyDataChanged();
				return;
			}

			var added = false;
			events.each(function(i) {
				var time = strptime($(this).attr("time"));
				if (time < event_time) {
					view.insertBefore($(this));
					added = true;
					return false;
				}
			});
			if (!added)
				eventsContainer.append(view);
			me.notifyDataChanged();
		};
		
		Events.prototype.inflateEvent = function(e) {
			var date = strptime(e.event_time, core.timezone);
			var eventView = $("<div class='event' time='" + date.format(core.DATETIME_FORMAT) + "'></div>");
			eventView.attr("key", e.id);
			eventView.append("<div class='date'><div class='month'>" + date.format("mmm").toUpperCase() + "</div>" + 
							"<div class='day'>" + date.format("d") + "</div></div>")
			if (e.photo)
				eventView.css("background-image", "url(" + e.photo.thumb_url + "300)")
			return eventView;
		};
		
		Events.prototype.notifyDataChanged = function() {
			var me = this;
			var events = me.view.find(".event");
			if (events.length > 0) {
				me.empty.hide();
			} else {
				me.empty.show();
			}
		};
		
		Events.prototype.clear = function() {
			var me = this;
			me.view.html("");
			me.years = {};
		};
		
		Events.prototype.fetch = function(filters) {
			var me = this;
			me.clear();
			me.loading.show();
			var api = "/events";
			if (filters) {
				var tags = [];
				var users = [];
				for (var i in filters) {
					var f = filters[i];
					if (f.type == "user") {
						users.push(f.key);
					} else if (f.type == "tag") {
						tags.push(f.key);
					}
				}
				var q = "";
				if (tags.length > 0) {
					q += "tags=" + tags.join(",");
				}
				if (users.length > 0) {
					if (q) q += "&";
					q += "u=" + users.join(",");
				}
				if (q) api += ("?" + q);
			}
			core.api(api, "GET", function(res) {
				if (res) {
					if (res.length > 0) {
						var year = null;
						for (var i in res) {
							var e = res[i];
							if (e.location) {
								var marker = core.Map.createMarker({ position:e.location });
								marker.event = e;
								core.Map.markers.push(marker);
							}
							var date = strptime(e.event_time, core.timezone);
							if (!year || date.getFullYear() != year.getYear()) {
								year = me.getYear(date.getFullYear());
							}
							var eventView = me.inflateEvent(e).appendTo(year.getEvents());
						}
					} 
					me.notifyDataChanged();
				}
				me.loading.hide();
			});
		};
		
		function Year(p, year) {
			var view = $("<div class='year' year='" + year + "'></div>");
			view.append("<div class='header'><span class='year-num'>" + year + "</span></div>");
			view.append("<div class='events'></div>");
			if (new Date().getFullYear() == year) {
				view.find(".header").hide();
			}
			var years = p.view.find(".year");
			if (years.length == 0) {
				p.view.append(view);
			} else {
				var added = false;
				years.each(function(i) {
					var currentYear = parseInt($(this).attr('year'), 10);
					if (currentYear < year) {
						view.insertBefore($(this));
						added = true;
						return false;
					}
				});
				if (!added)
					p.view.append(view);
			}
			this.view = view;
			this.year = year;
			this.events = view.find(".events");
		}
		
		Year.prototype.getYear = function() {
			return this.year;
		}
		
		Year.prototype.getEvents = function() {
			return this.events;
		}
		
		function ProgressBar(view) {
			var me = this;
			me.view = view;
			me.progress = me.view.find(".progress");
		}
		
		ProgressBar.prototype.setProgress = function(value) {
			var me = this;
			me.progress.css({ width:value + "%" });
		};
		
		function DialogEvent(view, opts) {
			var me = this;
			me.opts = opts;
			me.view = view;
			me.editable = me.view.find(".editable");
			me.desc = me.view.find(".dlg-event-desc");
			me.desccontent = me.desc.find(".desc-content");
			me.descbody = me.desc.find(".dlg-event-desc-body");
			me.descbuttons = me.desc.find(".buttons-desc");
			me.date = me.view.find(".btn-date");
			me.time = me.view.find(".btn-time");
			me.btnPhoto = me.view.find(".btn-photo");
			me.btnPlace = me.view.find(".btn-place");
			me.btnPeople = me.view.find(".btn-people");
			me.btnTag = me.view.find(".btn-tag");
			me.photo = me.view.find(".dlg-event-photo");
			me.place = me.view.find(".dlg-event-place");
			me.people = me.view.find(".dlg-event-people");
			me.tags = me.view.find(".dlg-event-tags");
			me.filePhoto = me.btnPhoto.find(".file-photo");
			me.mapimage = me.place.find("img");
			me.image = me.photo.find("img");
			me.progressbar = new ProgressBar(me.photo.find(".progressbar"));
			me.btnPost = me.view.find(".buttons-act .btn-post");
			me.loading = me.view.find(".dlg-event-loading");
			me.tagPicker = new TagPicker(me.view.find(".menu-tags"));
			me.loader = new Image();
			me.loader.onload = function() {
				me.image.attr("src", me.loader.src);
				me.image.show();
			};

			core.events.bind(me.tagPicker, "change", function() {
				var tags = me.tagPicker.getSelected();
				me.setTags(tags);
			});
			
			me.view.click(function() {
				me.dismiss();
			});
			
			me.view.find(".dlg-event-body").click(function(e) {
				e.stopPropagation();
			})
			.on('dragenter', function() {
				me.photo.show();
			})
			.on('dragover', function() {
			})
			.on('dragleave', function() {
			})
			.on('drop', function(e) {
				e.preventDefault();
				var files = e.target.files || e.originalEvent.dataTransfer.files;
				me.uploadPhotoFiles(files);
			});
			
			me.desc.find(".dlg-btn-edit").click(function() {
				me.editable.show();
				me.desccontent.hide();
				me.descbuttons.show();
				me.editable.html(me.descbody.html().replace(/(<[^>]*>)/g, function(match, p1, offset, str) {
					return p1 == "<br>" ? "\n" : "";
				}).replace(new RegExp("\n", "g"), "<br>"));
			});
			
			me.descbuttons.find(".btn-cancel").click(function() {
				me.editable.hide();
				me.desccontent.show();
				me.descbuttons.hide();
			});
			
			me.descbuttons.find(".btn-post").click(function() {
				me.update(["desc"], function(res) {
					if(res) {
						me.editable.hide();
						me.descbody.html(res.description);
						me.desccontent.show();
						me.descbuttons.hide();
						if (me.opts.onEventEdited) {
							me.opts.onEventEdited(res);
						}
					}
				});
			});
			
			me.btnPost.click(function() {
				me.update(["desc", "photo", "event_time", "people", "tags", "loc"], function(res) {
					if(res) {
						me.dismiss();
						if (me.opts.onEventAdded) {
							me.opts.onEventAdded(res);
						}
					}
				});
			});
			
			me.um = new UploadManager({
				onStart:function() {
					me.photo.show();
					me.image.hide();
					me.progressbar.view.show();
					me.progressbar.setProgress(0);
					me.btnPost.attr("disabled", "disabled");
				},
				progress:function(file, uploaded, total, percentage) {

				},
				fileprogress:function(i, file, progress) {
					me.progressbar.setProgress(progress);
				},
				uploaded:function(i, file, res) {
					if(res) {
						me.setPhoto(res);
						me.setDate(strptime(res.utc, core.timezone));
						if (res.location) {
							me.setLocation(res.location);
						}
					}
				},
				done:function() {
					me.btnPhoto.addClass("active");
					me.btnPost.removeAttr("disabled");
				}
			});
			
			me.filePhoto.change(function() {
				me.uploadPhotoFiles(this.files);
			});
		}
		
		DialogEvent.prototype.update = function(fields, cb) {
			var me = this;
			if (!me.editable.html().trim() && !me.photo.attr("key")) {
				return;
			}
			
			var data = {};
			for (var i in fields) {
				var f = fields[i];
				switch(f) {
				case 'desc':
					var desc = me.editable.html().trim().replace(/<div>/g, "")
												.replace(/(<br>|<\/div>)/g, "\n")
												.replace(/&amp;/g, "&")
												.replace(/&nbsp;/g, " ")
												.replace(/&lt;/g, "<")
												.replace(/&gt;/g, ">");
					data['desc'] = desc;
					break;
				case 'photo':
					data['pid'] = me.photo.attr("key");
					break;
				case 'event_time':
					data['event_time'] = me.datetime.format(core.DATETIME_FORMAT);
					break;
				case 'people':
					var people = [];
					var users = me.people.find(".user");
					users.each(function() {
						people.push($(this).attr("key"));
					});
					data['people'] = people;
					break;
				case 'tags':
					var selected_tags = [];
					var tags = me.tags.find(".tag");
					tags.each(function() {
						selected_tags.push($(this).attr("key"));
					});
					data['tags'] = selected_tags;
				case 'loc':
					if (me.loc) {
						data.loc = me.loc;
					}
					break;
				}
			}
			
			core.api("/event" + (("/" + me.key) || ""), "POST", data, function(res) {
				if(res) {
					if (cb) {
						cb(res);
					}
				}
			});
		};
		
		DialogEvent.prototype.reset = function() {
			var me = this;
			me.descbody.html("");
			me.photo.hide();
			me.place.hide();
			me.setPeople([]);
			me.setTags([]);
			me.photo.attr("key", "");
			me.view.find(".btn-icon").removeClass("active");
			me.loading.hide();
		};
		
		DialogEvent.prototype.setMode = function(key) {
			var me = this;
			if (key == 'new') {
				me.key = null;
				me.editable.html("");
				me.editable.show();
				me.descbuttons.hide();
				me.desccontent.hide();
				me.reset();
				me.btnPost.show();
				me.loc = null;
			} else {
				me.key = key;
				me.editable.hide();
				me.reset();
				me.desccontent.show();
				me.descbuttons.hide();
				me.btnPost.hide();
				core.api("/event/" + key, "GET", function(res) {
					if (res) {
						me.descbody.html(res.description);
						me.setDate(strptime(res.event_time, core.timezone));
						if (res.photo)
							me.setPhoto(res.photo);
						if (res.location) {
							me.setLocation(res.location);
						}
						me.setPeople(res.people);
						me.setTags(res.tags);
					}
					me.loading.hide();
				});
			}
		};
		
		DialogEvent.prototype.setDate = function(date) {
			var me = this;
			me.date.text(date.format("mmm d"));
			me.time.text(date.format("h:MM TT"));
			me.datetime = date.addHours(-core.timezone);
		};
		
		DialogEvent.prototype.setPhoto = function(photo) {
			var me = this;
			me.btnPhoto.addClass("active");
			me.photo.show();
			var url = photo.thumb_url + "600";
			if (me.loader.src === url) {
				me.image.attr("src", url);
				me.image.show();
			} else {
				me.loader.src = url;
				me.image.hide();
			}
			me.progressbar.view.hide();
			me.photo.attr("key", photo.id);
		};
		
		DialogEvent.prototype.setPeople = function(ids) {
			var me = this;
			if (ids.length > 0) {
				me.btnPeople.addClass("active");
				var wrap = $("<div></div>");
				for (var i in ids) {
					var user = core.Friend.lookup(ids[i]);
					wrap.append("<div class='user' key='" + user.id + "'><img src='" + user.profile_picture + "' /></div>");
				}
				me.people.html(wrap.html());
			} else {
				me.btnPeople.removeClass("active");
				me.people.html("");
			}
		};
		
		DialogEvent.prototype.setTags = function(tags) {
			var me = this;
			me.tags.html("");
			if (tags.length > 0) { 
				me.btnTag.addClass("active");
				for (var i in tags) {
					var tag = tags[i];
					me.tags.append("<span class='tag noselect active' key='" + tag +"'>" + tag + "</span>");
				}
			} else {
				me.btnTag.removeClass("active");
			}
		};
		
		DialogEvent.prototype.setLocation = function(loc) {
			var me = this;
			me.loc = loc;
			me.btnPlace.addClass("active");
			me.place.show();			
			me.mapimage.show();
			var w = me.place.width();
			var h = me.place.height();
			var url = "https://maps.googleapis.com/maps/api/staticmap?";
			var q = "center=" + loc.lat + "," + loc.lng + "&zoom=13&size=" + w + "x" + h + "&maptype=roadmap" + 
			"&markers=" + loc.lat + "," + loc.lng;
			me.mapimage.attr("src", url + q);
		};
		
		DialogEvent.prototype.uploadPhotoFiles = function(files) {
			var me = this;
			me.um.start(files, "/_api/photo");
		};
		
		DialogEvent.prototype.show = function() {
			this.view.show();
		}
		
		DialogEvent.prototype.dismiss = function() {
			this.view.hide();
		}
		
		function TagPicker(view) {
			var me = this;
			this.view = view;
			this.tags = view.find(".tags");
			this.input = view.find("input[type=text]");
			this.btnAdd = view.find(".btn-add");
			this.view.on("before_show", function() {
				me.setTags(core.Tag.tags);
			});
			
			this.tags.on("click", ".tag", function() {
				$(this).toggleClass("active");
			});
			
			this.inputAlarm = new Alarm(function() {
				if (me.input.val().trim() != "") {
					me.btnAdd.addClass("active");
				} else {
					me.btnAdd.removeClass("active");
				}
			});
			this.input.keyup(function(e) {
				me.inputAlarm.cancel();
				me.inputAlarm.start(200);
				if (e.which == 13 && $(this).val().trim() != "") {
					var tag = me.addTag($(this).val());
					tag.addClass("active")
					$(this).val("");
				}
			});
			
			this.view.find(".btn-post").click(function() {
				core.events.trigger(me, "change");
				me.view.hide();
			});
			
			this.view.find(".btn-cancel").click(function() {
				me.view.hide();
			});
		}
		
		TagPicker.prototype.setTags = function(tags) {
			var me = this;
			me.tags.html("");
			for (var i in tags) {
				var tag = tags[i];
				me.tags.append("<span class='tag noselect' key='" + tag +"'>" + tag + "</span>");
			}
		}
		
		TagPicker.prototype.addTag = function(tagname) {
			var me = this;
			var tag = me.tags.find(".tag[key=" + tagname + "]")
			if (tag.length > 0) {
				tag.addClass("active");
			} else {
				tag = $("<span class='tag noselect' key='" + tagname +"'>" + tagname + "</span>");
				me.tags.prepend(tag);	
			}
			return tag;
		}
		
		TagPicker.prototype.setSelected = function(tags) {
			
		}
		
		TagPicker.prototype.getSelected = function() {
			var tags = [];
			var me = this;
			me.tags.find(".tag.active").each(function() {
				tags.push($(this).attr("key"));
			});
			return tags;
		}
		
		$(function() {
			var searchbar = new SearchBar($("#searchbar"));
			
			var dlgEvent = null;
			$(".btn-menu").on("click", function(e) {
				e.stopPropagation();
				var target = $(this).attr("target");
				var menu = $(target);
				if(menu.is(":visible")) {
					$(".menu").hide();
				} else {
					$(".menu").hide();
					menu.trigger("before_show");
					menu.show();
					menu.trigger("show");
				}
			});
			
			$(".menu").each(function(i) {
				$(this).attr("menu-id", "menu-" + i);
				core.Menu.add($(this));
			});
			
			$(".menu").click(function(e) {
				e.stopPropagation();
			});
			
			$(document).click(function() {
				$(".menu").hide();
			})
			.on('dragenter', function(e) {
				e.stopPropagation();
				e.preventDefault();
			})
			.on('dragover', function(e) {
				e.stopPropagation();
				e.preventDefault();
			})
			.on('dragleave', function(e) {
				e.stopPropagation();
				e.preventDefault();
			})
			.on('drop', function(e) {
				e.stopPropagation();
				e.preventDefault();
			});
			
			var menuPeople = core.Menu.lookup($(".menu-people").attr("menu-id"));
			if (menuPeople) {
				menuPeople.corridor = {
					initial:false,
					loading:false
				};
				menuPeople.people = [];
				menuPeople.viewpeople = menuPeople.view.find(".people");
				menuPeople.view.on("click", ".user", function() {
					$(this).toggleClass("checked");
					var count = menuPeople.getSelected().length;
					menuPeople.btnPost.text("Apply" + (count > 0 ? "(" + count + ")" : ""));
				});
				
				menuPeople.view.find(".btn-cancel").click(function() {
					menuPeople.view.hide();
				});
				
				menuPeople.btnPost = menuPeople.view.find(".btn-post");
				menuPeople.btnPost.click(function() {
					var users = menuPeople.getSelected();
					var ids = [];
					users.each(function(i) {
						ids.push($(this).attr("key"));
					});
					dlgEvent.setPeople(ids);
					menuPeople.view.hide();
				});
				
				menuPeople.getSelected = function() {
					return menuPeople.view.find(".user.checked");
				};
				
				menuPeople.setSelected = function(ids) {
					menuPeople.getSelected().removeClass("checked");
					for (var i in ids) {
						menuPeople.view.find(".user[key=" + ids[i] +"]").addClass("checked");
					}
					var count = ids.length;
					menuPeople.btnPost.text("Apply" + (count > 0 ? "(" + count + ")" : ""));
				};
				
				core.events.bind(menuPeople, "show", function() {
					if (!menuPeople.corridor.initial && !menuPeople.corridor.loading) {
						menuPeople.corridor.loading = true;
						core.api("/me/friends", "GET", function(res) {
							if (res) {
								for (var i in res) {
									var user = res[i];
									core.Friend.add(user);
									menuPeople.viewpeople.append("<div class='user' key='" + user.id + "'>"
												+ "<img src=" + user.profile_picture + " />"
												+ "<div class='mask-check'>" + assets.svg.check + "</div>"
												+ "</div>")
								}
							}
							
							menuPeople.corridor.loading = false;
							menuPeople.corridor.initial = true;
						});
					}
				});
			}
			
			var events = new Events($("#events"), $("#empty"), $("#loading"), {
				onItemClick:function(id) {
					dlgEvent.setMode(id);
					dlgEvent.show();
				}
			});
			dlgEvent = new DialogEvent($("#dlg_event"), {
				onEventAdded:function(event) {
					events.addEvent(event);
					core.Tag.update();
				}
			});
			
			$(".btn-new").click(function() {
				dlgEvent.setMode('new');
				dlgEvent.setDate(new Date());
				dlgEvent.show();
			});
			
			events.fetch();
			
			core.events.bind(searchbar, "filter_change", function() {
				events.fetch(searchbar.getFilters());
			});
			
			$(".dlg").on("mousewheel DOMMouseScroll", function(e) {
				var scrollTo = null;

			    if (e.type == 'mousewheel') {
			        scrollTo = (e.originalEvent.wheelDelta * -1);
			    }
			    else if (e.type == 'DOMMouseScroll') {
			        scrollTo = 40 * e.originalEvent.detail;
			    }

			    if (scrollTo) {
			        e.preventDefault();
			        $(this).scrollTop(scrollTo + $(this).scrollTop());
			    }
			}).click(function() {
				$(this).hide();
			});
			
			$(".btn-map").click(function() {
				$("#dlg_map").show();
				var map = core.getMap($("#map_canvas")[0], {zoom:4, center:{lat:0, lng:0}});
				var markers = core.Map.markers;
				for (var i in markers) {
					var marker = markers[i];
					marker.setMap(map);
				}
				map.mc.clearMarkers();
				map.mc.addMarkers(markers);
				var bounds = core.Map.getBounds(markers);
				map.fitBounds(bounds);
			});
			
			$("#map_canvas").click(function(e) {
				e.stopPropagation();
			});
		});
		</script>
    </head>
    <body>
		<div id="main">
			<div class="buttons-main">
				<div class="buttons-right">
					<button class="btn-map">Map</button>
					<button class="btn-new btn-post">New Event</button>
				</div>
				<div id="searchbar" class="input-text">
					<svg class="icon-search" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" id="Your_Icon" x="0px" y="0px" width="40px" height="40px" viewBox="0 0 100 100" enable-background="new 0 0 100 100" xml:space="preserve">
					<path d="M99.337,89.242L68.052,57.956c4.063-6.057,6.246-13.179,6.246-20.636c0-9.923-3.864-19.252-10.881-26.269  C56.4,4.035,47.072,0.171,37.149,0.171c-9.923,0-19.252,3.864-26.269,10.88C3.864,18.068,0,27.397,0,37.32  s3.864,19.251,10.881,26.268s16.345,10.881,26.269,10.881c7.541,0,14.737-2.234,20.838-6.385l31.255,31.253  c1.055,1.056,2.995,0.826,4.332-0.511l5.252-5.252C100.164,92.237,100.393,90.297,99.337,89.242z M37.149,64.405  c-14.936,0-27.086-12.15-27.086-27.085s12.151-27.086,27.086-27.086c14.935,0,27.085,12.151,27.085,27.086  S52.084,64.405,37.149,64.405z"/>
					</svg>
					<span class="filters"></span><input id="input-search" type="text" placeholder="tag/people/content" autocomplete="off" />
					<span class="btn-add">
						
					</span>
				</div>
			</div>
			<div id="events"></div>
			<div id="empty" style="display:none;">
				There is no any event yet. <br /><button class="btn-new btn-post">New Event</button>
			</div>
			<div id="loading" style="display:none;"><img src="/static/images/loading.gif" /></div>
			<div id="dlg_map" class="dlg" style="display:none;">
				<div id="map_canvas"></div>
			</div>
			<div id="dlg_event" class="dlg" style="display:none;">
				<div class="dlg-event-body">
					<div class="dlg-event-header">
						<span class="btn-date"></span>
						<span class="btn-time"></span>
					</div>
					<div class="dlg-event-photo">
						<img />
						<div class="progressbar"><div class="progress"></div></div>
					</div>
					<div class="dlg-event-desc">
						<div class="editable" contenteditable="plaintext-only">
						</div>
						<div class="buttons-desc">
							<button class="btn-cancel">Cancel</button>
							<button class="btn-post">Save</button>
						</div>
						<div class="desc-content">
							<span class="dlg-event-desc-body"></span>
							<span class="dlg-btn-edit">Edit</span>
						</div>
					</div>
					<div class="dlg-event-people">
					</div>
					<div class="dlg-event-place">
						<img />
					</div>
					<div class="dlg-event-tags">
					</div>
					<div class="dlg-buttons">
						<div class="buttons-tools">
							<span class="btn-icon btn-photo">
								<form style="display: inline-block;">
									<label>
								<svg class="icon-photo" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" id="Layer_1" x="0px" y="0px" width="100.0px" height="100px" viewBox="0 0 512 512" enable-background="new 0 0 512 512" xml:space="preserve">
								<path d="M480,80v352H32V80H480 M512,48H0v416h512V48L512,48z M448,240l-96-96L224,272l-96-64l-64,96v96h384V240z"/>
								</svg>
									<input class="file-photo" type="file" />
									</label>
								</form>
							</span>
							<span class="btn-icon btn-people btn-menu" target=".menu-people">
								<svg class="icon-people" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" id="Layer_1" x="0px" y="0px" width="100px" height="100px" viewBox="0 0 100 100" enable-background="new 0 0 100 100" xml:space="preserve">
								<g>
									<path d="M78.685,56.269l-0.013-3.177c4.492,0.587,13.649-2.684,13.649-2.684c-3.104-3.174-3.806-6.879-5.844-21.417   C84.44,14.452,71.805,14.588,70.854,14.588S57.267,14.452,55.229,28.99c-2.038,14.538-2.74,18.243-5.843,21.417   c0,0,9.157,3.271,13.649,2.684l-0.013,3.177c-2.305,2.527-5.047,4.457-7.783,6.102c0.896,0.508,1.785,0.999,2.649,1.473   c6.106,3.35,11.874,6.513,11.874,12.85v6.926h28.4c0.975,0,1.765-0.791,1.765-1.766v-7.94   C99.928,66.631,86.677,65.033,78.685,56.269z"/>
								</g>
								<path d="M99.843,73.97v7.94"/>
								<path d="M43.186,57.071L43.186,57.071v-2.551c2.317-2.701,4.064-5.818,5.253-9.45  c0.169-0.519,0.328-1.048,0.474-1.587c1.214-0.623,2.202-2.282,2.424-4.317c0.075-0.677,0.059-1.331-0.035-1.936  c-0.158-1.007-0.531-1.874-1.053-2.472c0.104-1.927,0.108-3.963,0.018-6.109c-0.07-1.669-0.197-3.404-0.388-5.216  c-0.047-0.448-0.107-0.878-0.179-1.295c-1.807-10.416-11.285-11.445-14.886-11.454c-0.144-0.001-2.636-0.001-2.78,0  c-3.601,0.008-13.079,1.038-14.886,11.454c-0.072,0.417-0.132,0.848-0.179,1.295c-0.19,1.812-0.316,3.546-0.388,5.216  c-0.091,2.146-0.087,4.183,0.018,6.109c-0.523,0.598-0.896,1.465-1.052,2.472c-0.095,0.605-0.111,1.259-0.037,1.936  c0.224,2.035,1.21,3.695,2.425,4.317c0.294,1.08,0.633,2.116,1.019,3.112c1.155,2.989,2.723,5.609,4.709,7.925v2.55v0.001  C14.775,66.818,0.084,68.594,0.084,76.692v8.828c0,1.084,0.878,1.964,1.963,1.964h62.753c1.084,0,1.962-0.88,1.962-1.964v-8.828  C66.763,68.594,52.072,66.818,43.186,57.071z"/>
								</svg>
								<div class="menu menu-people">
									<div class="people">
									</div>
									<div class="buttons">
										<button class="btn-cancel">Cancel</button>
										<button class="btn-post">Apply</button>
									</div>
								</div>
							</span>
							<span class="btn-icon btn-place">
								<svg class="icon-marker" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" x="0px" y="0px" width="100px" height="100px" viewBox="0 0 100 100" enable-background="new 0 0 100 100" xml:space="preserve">
								<g id="Layer_7" display="none">
									<path display="inline" d="M84.938,26.044H15.062c-0.547,0-0.998,0.446-0.998,0.997v45.916c0,0.553,0.451,0.999,0.998,0.999h69.875   c0.555,0,0.998-0.446,0.998-0.999V27.041C85.936,26.49,85.492,26.044,84.938,26.044z M83.777,46.589H16.23v-9.98h67.547V46.589z"/>
								</g>
								<g id="Your_Icon" display="none">
									<path display="inline" d="M85.98,37.144c0-10.476-8.258-18.719-18.434-18.719c-8.217,0-15.168,5.661-17.549,13.31   c-2.383-7.648-9.334-13.113-17.551-13.113c-10.178,0-18.428,8.008-18.428,18.488c0,5.288,2.107,9.024,5.498,13.022h-0.049   l30.547,31.442l30.543-31.442h-0.08C83.871,46.134,85.98,42.428,85.98,37.144z"/>
								</g>
								<g id="Layer_6">
									<path d="M50,14.064c-13.23,0-23.957,10.726-23.957,23.957C26.043,51.25,50,85.936,50,85.936S73.957,51.25,73.957,38.021   C73.957,24.79,63.229,14.064,50,14.064z M50,50.497c-6.617,0-11.979-5.359-11.979-11.977c0-6.616,5.361-11.978,11.979-11.978   c6.613,0,11.979,5.362,11.979,11.978C61.979,45.138,56.613,50.497,50,50.497z"/>
								</g>
								<g id="Layer_5" display="none">
									<polygon display="inline" points="85.982,32.037 85.982,14.051 85.982,14.047 67.993,14.047 67.993,14.047 26.013,14.047    26.013,32.037 50.971,32.037 14.018,68.99 30.98,85.953 67.993,48.942 67.993,74.017 85.982,74.017 85.982,32.037  "/>
								</g>
								<g id="Layer_4" display="none">
									<polygon display="inline" points="62.011,14.107 38.022,14.107 54.017,38.097 14.034,38.097 14.034,62.082 54.015,62.082    38.022,86.071 62.011,86.071 86,50.087  "/>
								</g>
								</svg>
							</span>
							<span class="btn-icon btn-tag btn-menu" target=".menu-tags">
							<svg class="icon-tag" xmlns="http://www.w3.org/2000/svg" version="1.1" width="32" height="32" data-icon="tag" viewBox="0 0 32 32">
							  <path d="M.5 0c-.3 0-.5.2-.5.5v11c0 .3.206.706.406.906l19.281 19.281c.14.14.33.182.5.125h.031l11.594-11.594c.005-.011-.004-.02 0-.031.057-.17.015-.36-.125-.5l-19.281-19.281c-.2-.2-.606-.406-.906-.406h-11zm6 4c1.4 0 2.5 1.1 2.5 2.5s-1.1 2.5-2.5 2.5-2.5-1.1-2.5-2.5 1.1-2.5 2.5-2.5z"/>
							</svg>
							<div class="menu menu-tags">
								<div class="input-text">
									<input type="text" autocomplete="off" />
									<span class="btn-add">
										<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" x="0px" y="0px" width="100px" height="100px" viewBox="0 0 100 100" enable-background="new 0 0 100 100" xml:space="preserve">
										<g id="Plus">
											<circle stroke-width="6" stroke-miterlimit="10" cx="50" cy="50" r="47"/>
											<line stroke-width="6" stroke-miterlimit="10" x1="50" y1="19" x2="50" y2="79"/>
											<line stroke-width="6" stroke-miterlimit="10" x1="80" y1="50" x2="20" y2="50"/>
										</g>
										</svg>
									</span>
								</div>
								<div class="tags">
								</div>
								<div class="buttons">
									<button class="btn-cancel">Cancel</button>
									<button class="btn-post">Apply</button>
								</div>
							</div>
							</span>
						</div>
						<div class="buttons-act">
							<button class="btn-post">Done</button>
						</div>
					</div>
					<div class="dlg-event-loading" style="display:none;"><img src="/static/images/loading.gif" /></div>
				</div>
			</div>
		</div>
    </body> 
</html>