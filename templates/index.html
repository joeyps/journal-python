<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<title>{% block title %}Those Days{% endblock %}</title>
		<meta name="description" content="{% block description %}{% endblock %}"> 
		<meta http-equiv="content-type" content="text/html; charset=utf-8"/>
		<meta http-equiv="pragma" content="no-cache" />
		<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
		<link href='https://fonts.googleapis.com/css?family=Open+Sans:300,400,700' rel='stylesheet' type='text/css'>
		<link href='/static/css/default.css' rel='stylesheet' type='text/css'>
		<style type="text/css">
		body {
			background:#343640;
		}
		#main { 
			min-width:350px;
			margin: 0 auto;
			transition:filter .3s;
		}
		
		#main.blur {
			-webkit-filter: blur(2px);
			-moz-filter: blur(2px);
			-o-filter: blur(2px);
			-ms-filter: blur(2px);
			filter: blur(2px);
		}
		
		#loading { 
			text-align: center; 
		}
		
		.buttons-main {
			position:relative;
		}
		
		.buttons-main .input-text {
			margin-right: 165px;
			max-width: 400px;
			padding-left:40px;
			padding-right:40px;
			border-radius: 15px;
		}
		
		.buttons-main .input-text input[type=text] {
			width:100%;
			box-sizing:border-box;
			font-size: 14px;
			padding:4px;
		}
		
		.buttons-main .input-text .icon-search {
			width: 20px;
			height: 20px;
			position: absolute;
			top: 9px;
			left: 12px;
			fill: #dc2528;
		}
		
		.buttons-main .input-text .icon-clear {
			width: 20px;
			height: 20px;
			position: absolute;
			top: 7px;
			right: 12px;
			fill: #ccc;
			cursor:pointer;
		}
		
		.buttons-right {
			position:absolute;
			right:2px;
			top:2px;
		}
		
		.buttons-right .btn-notice {
			display: inline-block;
			height: 28px;
			width: 28px;
			text-align: right;
			padding: 0px 10px;
		}
		
		.buttons-right .btn-notice span {
			position:relative;
			top: 3px;
		}
		
		.buttons-right .btn-notice span .count {
			position: absolute;
			bottom: 0px;
			right: -12px;
			border-radius: 2px;
			-webkit-box-shadow: 0 1px 1px rgba(0, 0, 0, .7);
			background-color: #dc0d17;
			background-image: -webkit-gradient(linear, center top, center bottom, from(#fa3c45), to(#dc0d17));
			background-image: -webkit-linear-gradient(#fa3c45, #dc0d17);
			color: #fff;
			min-height: 13px;
			padding: 2px 3px;
			text-shadow: 0 -1px 0 rgba(0, 0, 0, .4);
			font-size: 12px;
			display: inline-block;
		}
		
		.buttons-right .btn-notice svg {
			fill: #fff;
			width: 18px;
			height: 18px;
		}
		
		.btn-align-top {
			background-color:rgba(0, 0, 0, 0.5);
			position:fixed;
			right:10px;
			bottom:-60px;
			border-radius:4px;
			padding: 8px;
			-webkit-transition:bottom .5s ease-in-out;
			transition:bottom .5s ease-in-out;
			cursor:pointer;
		}
		
		.btn-align-top.show {
			bottom:10px;
		}
		
		.btn-align-top .icon-align-top {
			fill:#91949d;
			width:36px;
			height:36px;
			display: block;
		}
		
		.btn-align-top:hover .icon-align-top {
			fill:#fff;
		}
		
		.sidepanel-mask {
			visibility:hidden;
			position:fixed;
			top:0;
			bottom:0;
			left:0;
			right:0;
			background-color:rgba(0, 0, 0, 0.5);
			opacity:0;
			transition: visibility 0.3s, opacity 0.3s ease-in-out ;
		}
		
		.sidepanel-mask.show {
			opacity:1;
			visibility:visible;
		}
		
		.sidepanel {
			background-color:#393939;
			position:fixed;
			right:-500px;
			top:0px;
			bottom:0px;
			width:30%;
			min-width:320px;
			max-width:500px;
			-webkit-transition: right 0.3s ease-in-out ; /* For Safari 3.1 to 6.0 */
			transition: right 0.3s ease-in-out ;
			-webkit-box-shadow: -2px 2px 4px rgba(0,0,0,.15);
			box-shadow: -2px 2px 4px rgba(0,0,0,.15);
			
			overflow-y: scroll;
		}
		
		.sidepanel .header {
			text-align:right;
		}
		
		.sidepanel .header svg {
			fill: rgba(255, 255, 255, 0.5);
			width: 45px;
			height: 45px;
		}
		
		.sidepanel.open {
			right:0px;
		}
		
		.notification {
			
		}
		
		.notification .date {
			color: rgba(0, 0, 0, 0.3);
			font-weight: bold;
			font-size: 20px;
			padding: 0px 20px 10px;
		}
		
		.notification .loadmore {
			text-align:center;
			padding:10px;
		}
		
		.notification .loadmore span {
			color:#fff;
			background-color:rgba(0, 0, 0, 0.5);
			display:inline-block;
			padding:5px 20px;
			border-radius:3px;
			cursor:pointer;
		}
		
		.notification .msg {
			background-color:rgba(255, 255, 255, 0.9);
			-webkit-border-radius: 3px;
			border-radius: 3px;
			-webkit-box-shadow: 0 1px 2px rgba(0,0,0,.2);
			box-shadow: 0 1px 2px rgba(0,0,0,.2);
			-webkit-transition: margin .2s;
			transition: margin .2s ease-in-out;
			margin: 0 20px 8px;
			overflow: hidden;
			position: relative;
			padding:10px 20px;
			height:80px;
			box-sizing: border-box;
		}
		
		.notification .msg.read {
			background-color:rgba(255, 255, 255, 0.7);
		}
		
		.notification .msg:after {
			content:" ";
			display:block;
			clear:both;
		}
		
		.notification .msg .time {
			padding-top:3px;
		}
		
		.notification .msg .sender-profile-picture {
			float:left;
			border-radius:50%;
			width:40px;
			height:40px;
		}
		
		.notification .msg .target-photo {
			float:right;
		}
		
		.notification .msg .content {
			margin-left:50px;
		}
		
		.notification .loading-f {
			height: 0px;
			overflow-y: hidden;
			transition: height 0.3s ease-in-out;
		}
		
		.notification .loading-f.play {
			height: 50px;
			display:block;
		}
		
		.dlg .dlg-body {
			background-color: #fff;
			max-width: 500px;
			min-width: 320px;
			margin: 3% auto;
			min-height: 100px;
			padding: 20px;
			border-radius: 4px;
		}
		
		#dlg_tags .dlg-content:after,
		#dlg_friends .dlg-content:after {
			clear:both;
			content:" ";
			display:block;
		}
		
		#dlg_tags .dlg-content>div {
			width:230px;
			float:left;
		}
		
		#dlg_tags .dlg-content .tag-event-count {
			margin-left:40px;
		}
		
		#dlg_friends .dlg-content>div.user {
			float:left;
			width:100px;
			margin:0px 15px 10px 0px;
		}
		
		#dlg_friends .dlg-content img {
			width:100px;
			height:100px;
		}
		
		#dlg_friends .dlg-content .user-name {
			height:50px;
			text-align:center;
			padding-top:5px;
		}
		
		.dlg .dlg-header {
			font-size:30px;
			font-weight:bold;
			color:rgba(0, 0, 0, 0.5);
			padding:10px 0;
		}
		
		#boxes {
			margin: 40px auto;
			position: relative;
		}
		
		#events {

		}
		
		.events:after {
			content:" ";
			clear:both;
			display:block;
		}
		
		#events .year {
			margin-bottom:20px;
		}
		
		#events .year .header {
			text-align: center;
			padding-bottom: 30px;
		}
		
		#events .year .header .year-num {
			color: #fff;
			background: #e63d35;
			border-radius: 2px;
			padding: 5px 10px;
			display: inline-block;
			font-size: 24px;
		}
		
		.box {
			position:absolute;
			width:255px;
		}
		
		.box.user {
			border-radius:6px;
			overflow:hidden;
		}
		
		.box.user .portrait {
			background-color: rgba(0, 0, 0, 0.5);
			padding: 53px 63px 30px;
		}
		
		.box.user .portrait img {
			width:128px;
			height:128px;
		}
		
		.box.user .profile {
			background-color: rgba(0, 0, 0, 0.5);
			padding:10px 10px;
			color:#fff;
			text-align:center;
		}
		
		.box.user .profile h1 {
			font-size: 18px;
			margin: 0 0 24px;
		}
		
		.box.user .menu-item {
			margin-top:1px;
			background-color: rgba(0, 0, 0, 0.5);
		}
		
		.box.user .menu-item:hover {
			background-color: #f64c3f;
			cursor:pointer;
		}
		
		.box.user .menu-item a,
		.box.user .menu-item span {
			display: block;
			vertical-align: middle;
			line-height: 48px;
			padding-left: 50px;
			color:#fff;
		}
		
		.box.user .menu-item a:hover {
			text-decoration: none;
		}
		
		#events .event {
			/*background-color:#ccc;
			background-size:cover;
			float:left;
			width:170px;
			height:170px;
			margin-right:3px;
			margin-bottom:3px;*/
		}
		
		#events .event .photo {
			position:relative;
		}
		
		#events .event .photo img {
			display:block;
		}
		
		#events .event .desc {
			background-color:#fff;
			padding:25px 15px;
			position:relative;
		}
		
		#events .event .desc .owner {
			border: 2px solid #fff;
			border-radius: 50%;
			width: 48px;
			height: 48px;
			margin-bottom: 15px;
			margin-left: 15px;
		}
		
		#events .event .desc .owner.owner-float {
			position:absolute;
			right: 10px;
			top: -30px;
			margin-bottom: 0px;
			margin-left: 0px;
		}
		
		#events .event .up-corner {
			border-top-left-radius:6px;
			border-top-right-radius:6px;
			overflow:hidden;
		}
		
		#events .event .date,
		.div-photo .date {
			position:absolute;
			left:10px;
			bottom:8px;
			color:#fff;
			text-shadow: 0px 0px 1px #444;
		}
		
		#events .event .date .day,
		.div-photo .date .day {
			font-size:24px;
			text-align:center;
		}
		
		#events .event .place {
			background-color:#fff;
		}
		
		#events .event .place>span {
			display:inline-block;
			vertical-align:middle;
		}
		
		#events .event .tags {
			position: absolute;
			right: 0px;
			top: 28px;
		}
		
		#events .event .tags>span {
			float:right;
			display:block;
			width:4px;
			height:26px;
			margin-right:-4px;
			background-color: #f64c3f;
		}
		
		#events .event .tags>span:hover ~ .labels {
			display:block;
		}
		
		#events .event .labels {
			display:none;
		}
		
		#events .event .labels:hover {
			display:block;
		}
		
		#events .event .tags .label {
			display:inline-block;
			vertical-align: middle;
			line-height: 26px;
			padding:0 10px;
			background-color: #f64c3f;
			color:#fff;
			cursor:pointer;
		}
		
		#events .event .event-footer {
			background-color: rgba(0, 0, 0, 0.5);
			border-bottom-left-radius:6px;
			border-bottom-right-radius:6px;
			overflow:hidden;
			color:#fff;
			white-space: nowrap;
		}
		
		#events .event .event-footer .btn-icon {
			display:inline-block;
			height:48px;
			padding:0 10px;
			vertical-align:middle;
		}
		
		#events .event .event-footer .btn-icon:hover {
			background-color: #f64c3f;
		}
		
		#events .event .event-footer .btn-icon .icon-share {
			fill:#fff;
			width: 32px;
			height: 32px;
			margin-top: 7px;
		}
		
		#events .event .event-footer .btn-icon .icon-clear {
			width: 24px;
			height: 24px;
			fill: #fff;
			margin-top: 11px;
		}
		
		#events .event .event-footer .btn-icon .icon-clear,
		#events .event .event-footer .btn-icon .icon-share {
			width:42px;
		}
		
		
		#events .event .event-footer .btn-fb {
			background-color: #4c66a4;
			margin-left: 200px;
			transition: margin-left .3s ease-out;
		}
		
		#events .event .event-footer .btn-fb.show {
			margin-left: 0px;
		}
		
		#events .event .event-footer .btn-icon .icon-fb {
			fill:#fff;
			width:36px;
			height:36px;
			margin-top: 5px;
		}
		
		.events-place {
			width:400px;
			max-height:400px;
			overflow-y:scroll;
		}
		
		.events-place .header {
			padding:20px 10px;
		}
		
		.events-place .event {
			padding: 5px 0px;
		}
		
		.events-place .event:after {
			content:" ";
			display:block;
			clear:both;
		}
		
		.events-place .event div.photo {
			float:left;
			width:100px;
			height:100px;
			background-size:cover;
			margin:0px 5px;
			border-radius:3px;
		}
		
		.events-place .event .date {
			float:right;
			margin-right: 10px;
		}
		
		.events-place .event .date .day {
			font-size:24px;
			text-align:center;
		}
		
		.events-place .event div.detail {
			padding:0 100px 0 100px;
		}
		
		.events-place .event .desc {
			padding: 10px 5px;
			height:60px;
			line-height:18px;
			overflow:hidden;
		}
		
		.event-single {
			width:300px;
		}
		
		.event-single .div-photo {
			position:relative;
		}
		
		.event-single img.photo {
			width:100%;
		}
		
		.event-single .desc {
			padding:20px 10px;;
		}
		
		.tag {
			background-color: #efefef;
			border: 1px solid #ccc;
			color: #777;
			border-radius: 9px;
			padding: 3px 8px;
			margin:3px;
			display: inline-block;
			cursor: pointer;
		}
		
		.tag+.tag {
			margin-left:5px;
		}
		
		.tag.active {
			background-color: #3a91f4;
			border-color: #284c71;
			color: #fff;
		}
		
		.dlg {
			position:fixed;
			top:0;
			bottom:0;
			left:0;
			right:0;
			background-color:rgba(0, 0, 0, 0.5);
			overflow-y:scroll;
		}
		
		.dlg #map_canvas {
			max-width:700px;
			min-width: 350px;
			height: 100%;
			margin: 0 auto;
		}
		
		#dlg_event .dlg-body {
			max-width:500px;
			min-width: 350px;
			box-sizing: border-box;
			margin: 30px auto;
			padding:10px;
			background-color:#fff;
			position:relative;
		}
		
		#dlg_event .dlg-event-desc {
			padding:10px 0;
		}
		
		.dlg .dlg-btn-edit {
			color:#999;
			font-size:10px;
			margin-left:5px;
			cursor:pointer;
		}
		
		.dlg .dlg-btn-edit:hover {
			text-decoration:underline;
		}
		
		#dlg_event .dlg-event-desc .dlg-btn-edit {
			display:none;
		}
		
		#dlg_event .dlg-event-desc:hover .dlg-btn-edit {
			display:inline-block;
		}
		
		#dlg_event .dlg-buttons:after,
		.dlg .dlg-event-people:after {
			clear:both;
			content:" ";
			display:block;
		}
		
		#dlg_event .buttons-tools {
			float:left;
		}
		
		#dlg_event .buttons-act {
			text-align:right;
		}
		
		.dlg .dlg-buttons .btn-icon {
			width:30px;
			height:30px;
			display: inline-block;
			vertical-align: middle;
			margin-right: 18px;
			position:relative;
		}
		
		.dlg .dlg-buttons .btn-icon>svg,
		.dlg .dlg-buttons .btn-icon .icon-photo {
			fill:#ccc;
			opacity:0.7;
		}
		
		.dlg .dlg-buttons .btn-icon svg:hover {
			opacity:1;
		}
		
		.dlg .dlg-buttons .btn-icon.active>svg,
		.dlg .dlg-buttons .btn-icon.active .icon-photo {
			fill:#dd4b39;
			opacity:1;
		}
		
		#dlg_event .btn-icon .icon-photo {
			width: 28px;
			height: 28px;
		}
		
		#dlg_event .btn-icon .icon-people {
			width: 24px;
			height: 24px;
			margin-top: 2px;
			margin-left: 7px;
		}
		
		#dlg_event .btn-icon .icon-marker {
			width: 30px;
			height: 30px;
		}
		
		#dlg_event .btn-icon .icon-tag {
			width: 20px;
			height: 20px;
			padding-top: 5px;
			padding-left: 2px;
		}
		
		.dlg .dlg-place-picker .map-canvas {
			height:300px;
		}
		
		.dlg .dlg-event-photo {
			background-color:#f5f5f5;
			min-height:200px;
			max-height:400px;
			position:relative;
			text-align:center;
			font-size:0; /* avoid padding-bottom for img */
		}
		
		.dlg .dlg-event-photo img {
			display:inline;
			max-height:400px; 
			max-width:100%;
		}
		
		/*.dlg .dlg-event-place {
			background-color:#ccc;
			position:relative;
			text-align:center;
		}
		
		.dlg .dlg-event-place img {
			display:block;
			width:100%;
			min-height:150px;
		}*/
			
		.dlg .dlg-event-place span {
			display:inline-block;
			vertical-align:middle;
		}
			
		.dlg .dlg-event-place svg.icon-marker,
		#events .event svg.icon-marker {
			fill:red;
			width:30px;
			height:30px;
		}
		
		.dlg .dlg-event-people {
			padding: 10px 0px;	
		}
		
		.dlg .dlg-event-people .user {
			float:left;
			width:50px;
			height:50px;
			margin:0px 2px 2px 0px;
			position:relative;
		}
		
		.dlg .dlg-event-people .user img {
			width:100%;
			height:100%;
			border-radius:2px;
		}
		
		#dlg_event .progressbar {
			display:inline-block;
			position: absolute;
			top:50%;
			left: 30px;
			right: 30px;
		}
		
		#dlg_event .dlg-event-loading {
			position:absolute;
			top:50%;
			left:0;
			right:0;
			text-align:center;
		}
		
		.dlg .dlg-buttons {
			padding-top:10px;
		}
	
		.progressbar {
			background-color: #e5e5e5;
			height: 4px;
		}
	
		.progressbar .progress {
			height: 2px;
			border: 1px solid #edba3d;
			background-color: #f8bd34;
			width:0%;
			position: absolute;
		}
		
		.menu-people {
			right:-115px;
			width:230px;
		}
		
		.menu-people .people:after {
			content:" ";
			display:block;
			clear:both;
		}
		
		.menu-people .user {
			float:left;
			width:50px;
			height:50px;
			margin:0px 2px 2px 0px;
			position:relative;
		}
		
		.menu-people .user img {
			width:100%;
			height:100%;
		}
		
		.menu-people .user .mask-check {
			position:absolute;
			left:0;
			right:0;
			top:0;
			bottom:0;
			background-color:rgba(0, 0, 0, 0.3);
			display:none;
			text-align:center;
		}
		
		.menu-people .user:hover .mask-check,
		.menu-people .user.checked .mask-check {
			display:block;
		}
		
		.menu-people .user.checked .mask-check svg {
			fill:#449c2f;
		}
		
		.menu-people .mask-check svg {
			width: 24px;
			height: 24px;
			margin-top: 12px;
		}
		
		.menu-people .buttons {
			text-align:right;
		}
		
		.menu-tags {
			width:250px;
			right:-120px;
		}
		
		.menu-tags .input-text input {
			border-width: 0px;
			width: 100%;
			box-sizing: border-box;
			padding-right: 30px;
			margin-top: 5px;
		}
		
		.menu-tags .input-text .btn-add {
			position: absolute;
			right: 6px;
			top: 8px;
		}
		
		.menu-tags .input-text .btn-add svg {
			width: 20px;
			height: 20px;
			stroke: #ccc;
			fill: none;
		}
		
		.menu-tags .input-text .btn-add.active svg {
			stroke: #449c2f;
		}
		
		.map-controls {
			margin-top: 16px;
			border: 1px solid transparent;
			border-radius: 2px 0 0 2px;
			box-sizing: border-box;
			-moz-box-sizing: border-box;
			height: 32px;
			outline: none;
			box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
		}
		
		.text-search-place {
			background-color: #fff;
			padding: 0 11px 0 13px;
			width: 400px;
			font-family: Roboto;
			font-size: 15px;
			font-weight: 300;
			text-overflow: ellipsis;
		}

		.text-search-place:focus {
			border-color: #4d90fe;
			margin-left: -1px;
			padding-left: 14px;  /* Regular padding-left + 1. */
			width: 401px;
		}
		
		.droparea {
			display:table;
			background-color: #f64c3f;
			width: 300px;
			height: 300px;
			border-radius: 50%;
			/* display: initial; */
			margin-left:-150px;
			margin-top:-150px;
			position: absolute;
			top:50%;
			left:50%;
		}
		
		.droparea .droparea-info {
			display:table-cell;
			vertical-align: middle;
			text-align: center;
			color:#fff;
			font-size:18px;
			font-weight:bold;
		}
		
		.droparea.play {
			-webkit-animation: bounce 0.7s infinite; /* Chrome, Safari, Opera */
			animation: bounce 0.7s infinite;
			-webkit-animation-timing-function: linear;
		}
		
		/* Chrome, Safari, Opera */
		@-webkit-keyframes bounce {
		    0% {
				width: 300px;
				height: 300px;
			}
		    50% {
				width: 330px;
				height: 330px;
				margin-left:-165px;
				margin-top:-165px;
			}
		    100% {
				width: 300px;
				height: 300px;
			}
		}

		@keyframes bounce {
		    0% {
				width: 300px;
				height: 300px;
			}
		    50% {
				width: 330px;
				height: 330px;
				margin-left:-165px;
				margin-top:-165px;
			}
		    100% {
				width: 300px;
				height: 300px;
			}
		}
		
		.autocomplete-suggestions { border: 1px solid #999; background: #FFF; overflow: auto; }
		.autocomplete-suggestion { padding: 3px 5px; white-space: nowrap; overflow: hidden; cursor:pointer;}
		.autocomplete-suggestion img { width:40px; height:40px; float:left; border-radius:2px;}
		.autocomplete-suggestion .autocomplete-suggestion-info { margin-left:50px; margin-top: 12px;}
		.autocomplete-suggestion:after { content:" "; display:block; clear:both;}
		.autocomplete-selected { background: #F0F0F0; }
		.autocomplete-suggestions strong { font-weight: normal; color: #3399FF; }
		
		/* loading animation*/
		.loading {
			text-align:center;
		}

		.loading .loading-circle {
			background-color:rgba(255, 255, 255, 0);
			display:inline-block;
			height: 24px;
			margin-left: 8px;
			width: 24px;
			-moz-animation-name:bounce_circle;
			-moz-animation-duration:1.9500000000000002s;
			-moz-animation-iteration-count:infinite;
			-moz-animation-direction:linear;
			-moz-border-radius:50%;
			-webkit-animation-name:bounce_circle;
			-webkit-animation-duration:1.9500000000000002s;
			-webkit-animation-iteration-count:infinite;
			-webkit-animation-direction:linear;
			-webkit-border-radius:50%;
			-ms-animation-name:bounce_circle;
			-ms-animation-duration:1.9500000000000002s;
			-ms-animation-iteration-count:infinite;
			-ms-animation-direction:linear;
			-ms-border-radius:50%;
			-o-animation-name:bounce_circle;
			-o-animation-duration:1.9500000000000002s;
			-o-animation-iteration-count:infinite;
			-o-animation-direction:linear;
			-o-border-radius:50%;
			animation-name:bounce_circle;
			animation-duration:1.9500000000000002s;
			animation-iteration-count:infinite;
			animation-direction:linear;
			border-radius:50%;
		}

		.loading .loading-circle.loading-circle-1 {
			-moz-animation-delay:0.39s;
			-webkit-animation-delay:0.39s;
			-ms-animation-delay:0.39s;
			-o-animation-delay:0.39s;
			animation-delay:0.39s;
		}

		.loading .loading-circle.loading-circle-2 {
			-moz-animation-delay:0.9099999999999999s;
			-webkit-animation-delay:0.9099999999999999s;
			-ms-animation-delay:0.9099999999999999s;
			-o-animation-delay:0.9099999999999999s;
			animation-delay:0.9099999999999999s;
		}

		.loading .loading-circle.loading-circle-3 {
			-moz-animation-delay:1.1700000000000002s;
			-webkit-animation-delay:1.1700000000000002s;
			-ms-animation-delay:1.1700000000000002s;
			-o-animation-delay:1.1700000000000002s;
			animation-delay:1.1700000000000002s;
		}

		@-moz-keyframes bounce_circle {
			0%{
			}

			50%{
			background-color:#f64c3f}

			100%{
			}
		}

		@-webkit-keyframes bounce_circle {
			0%{
			}

			50%{
			background-color:#f64c3f}

			100%{
			}
		}

		@-ms-keyframes bounce_circle {
			0%{
			}

			50%{
			background-color:#f64c3f}

			100%{
			}
		}

		@-o-keyframes bounce_circle {
			0%{
			}

			50%{
			background-color:#f64c3f}

			100%{
			}
		}

		@keyframes bounce_circle {
			0%{
			}

			50%{
			background-color:#f64c3f}

			100%{
			}
		} 
		</style>
		<script type="text/javascript" src="/static/js/assets.js"></script>
		<script type="text/javascript" src="/static/js/date.format.js"></script>
		<script type="text/javascript" src="//maps.googleapis.com/maps/api/js?sensor=false&libraries=places"></script>
		<script type="text/javascript" src="/static/js/markerclusterer.js"></script>
		<script type="text/javascript" src="/static/js/infobox.js"></script>
		<script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/2.1.0/jquery.min.js"></script>
		<script type="text/javascript" src="/static/js/jquery.autocomplete.js"></script>
		<script type="text/javascript" src="/static/js/core.js"></script>
		<script type="text/javascript">
		core.user = {{ json_user }};
		core.Map = {
			createMarker:function(opts) {
				var marker = new google.maps.Marker(opts);
				google.maps.event.addListener(marker, 'click', function() {
					var e = marker.event;
					var v = $("<div class='event-single'></div>");
					if (e.photo) {
						var date = strptime(e.event_time, core.timezone);
						var divPhoto = $("<div class='div-photo'><img class='photo' src='"
							 					+ e.photo.thumb_url + "400' /></div>").appendTo(v);
						var h = 300.0 * e.photo.height / e.photo.width;
						divPhoto.css({ height: h + "px" });
						divPhoto.append("<div class='date'><div class='month'>" + date.format("mmm").toUpperCase() + "</div>" + 
																"<div class='day'>" + date.format("d") + "</div></div>")
					}
					if (e.description) {
						v.append("<div class='desc'>" + e.description + "</div>")
					}
					var wrap = $("<div>");
					wrap.append(v);
					core.Map.infobox.setContent(wrap.html());
					core.Map.infobox.open(core._map, marker.getPosition());
				});
				return marker;
			},
			getBounds:function(markers) {
				var bounds = new google.maps.LatLngBounds();
				for(var i in markers) {
					bounds.extend(markers[i].getPosition());
				}
				return bounds;
			},
			markers:[],
			infobox:new InfoBox({ pixelOffset:new google.maps.Size(0, -30) })
		}
		
		core.getMap = function(canvas, opts) {
			if (core._map) return core._map;
			var mapOptions = {
				center: opts.center,
				zoom: opts.zoom,
				mapTypeId: google.maps.MapTypeId.ROADMAP
			};
			var map = new google.maps.Map(canvas, mapOptions);
			core._map = map;
			var mc = new MarkerClusterer(map, null, { zoomOnClick:false });
			map.mc = mc;
			
		    google.maps.event.addListener(mc, 'clusterclick', function(cluster) {
				var div = $("<div class='events-place'>");
				var center = cluster.getCenter();
				div.append("<div class='header'>Near by " + center.lat() + "," + center.lng() + "</div>");
				var markers = cluster.getMarkers();
				for (var i in markers) {
					var e = markers[i].event;
					var v = $("<div class='event'></div>").appendTo(div);
					if (e.photo) {
						v.append("<div class='photo' style='background-image:url(" + e.photo.thumb_url + "300);'></div>")
					}
					var date = strptime(e.event_time, core.timezone);
					v.append("<div class='date'><div class='month'>" + date.format("mmm").toUpperCase() + "</div>" + 
									"<div class='day'>" + date.format("d") + "</div></div>")
					v.append("<div class='detail'><div class='desc'>"
						 					+ (e.description || "") + "</div></div>")
				}
				var wrap = $("<div>");
				wrap.append(div);
				core.Map.infobox.setContent(wrap.html());
				core.Map.infobox.open(map, center);
		    });
			return map;
		};
		
		core.Friend = {
			users:{},
			add:function(user) {
				core.Friend.users[user.id] = user;
			},
			lookup:function(id) {
				return core.Friend.users[id];
			}
		};
		
		core.Tag = {
			tags:{},
			add:function(tagname) {
				core.Tag.tags[tagname] = tagname;
			},
			lookup:function(id) {
				return core.Tag.tags[id];
			},
			update:function() {
				core.Tag.tags = {};
				core.api("/tag", "GET", function(res) {
					if (res) {
						for (var i in res) {
							core.Tag.add(res[i]);
						}
					}
				});
			}
		};
		
		core.Tag.update();
		
		core.api("/me/friends", "GET", function(res) {
			if (res) {
				for (var i in res) {
					core.Friend.add(res[i]);
				}
			}
		});
		
		core.Menu = {
			menus:{},
			add:function(view) {
				var menus = core.Menu.menus;
				var id = view.attr("menu-id");
				if (!menus[id]) {
					menus[id] = new Menu(view);
				}
				return menus[id];
			},
			lookup:function(id) {
				return core.Menu.menus[id];
			}
		};
		
		function Menu(view) {
			var me = this;
			this.view = view;
			this.view.on("show", function() {
				core.events.trigger(me, "show");
			});
		}
		
		function SearchBar(view) {
			var me = this;
			me.view = view;
			me.view.focus(function() {
				me.input.focus();
			});
			me.btnClear = me.view.find(".icon-clear").click(function() {
				me.clearFilters();
				me.notifyFiltersChanged();
			});
			me.filters = me.view.find(".filters");
			me.input = me.view.find("#input-search");
			me.input.autocomplete({
				lookup:[],
				//noCache: true,//TODO use cache
				triggerSelectOnValidInput: false,
			    onSelect: function (suggestion) {
					var type = suggestion.type;
					if (type == 'tag') {
						var tag = suggestion.data;
						me.addTag(tag);
						me.onFilterChanged();
					} else if (type == 'user') {
						var user = suggestion.data;
						me.addUser(user);
						me.onFilterChanged();
					}
					
					me.input.val("");
			    },
				onCreateView: function(value, suggestions) {
					var html = "";
					for (var i in suggestions) {
						var suggestion = suggestions[i];
						var type = suggestion.type;
						if (type === 'user') {
							html += '<div class="autocomplete-suggestion" data-index="' + i + '">' + 
									'<img src="' + suggestion.data.profile_picture + '" />' + 
									'<div class="autocomplete-suggestion-info">With ' + $.Autocomplete.formatResult(suggestion, value) +
									'</div></div>';
						} else if (type === 'tag') {
							html += '<div class="autocomplete-suggestion" data-index="' + i + '">' + 
									'<div>' + $.Autocomplete.formatResult(suggestion, value) +
									'</div></div>';
						}
					}
					return html;
				}
			}).focus(function() {
				var lookup = [];
				var friends = core.Friend.users;
				for (var i in friends) {
					var user = friends[i];
					lookup.push({ value:user.name, data:user, type:'user' });
				}
				var tags = core.Tag.tags;
				for (var i in tags) {
					var tag = tags[i];
					lookup.push({ value:tag, data:tag, type:'tag' });
				}
				var opts = {'lookup':lookup};
				$(this).autocomplete('setOptions', opts);
			}).keydown(function(e) {
				if (e.which == 8 && $(this).val().trim() == "") {
					me.filters.find(".filter:last").remove();
					me.onFilterChanged();
				}
			});
		}
		
		SearchBar.prototype.clearFilters = function() {
			this.filters.find(".filter").remove();
		};
		
		SearchBar.prototype.addUser = function(user) {
			this.filters.append("<span class='tag active filter' key='" + user.id
				 						+ "' type='user'>" + user.name + "</span>");
			
		};
		
		SearchBar.prototype.addTag = function(tag) {
			this.filters.append("<span class='tag active filter' key='" + tag + "' type='tag'>" + tag + "</span>");
		};
		
		SearchBar.prototype.getFilters = function() {
			var me = this;
			var filters = [];
			me.filters.find(".filter").each(function() {
				filters.push({ type:$(this).attr("type"), key:$(this).attr("key")});
			});
			return filters;
		};
		
		SearchBar.prototype.notifyFiltersChanged = function() {
			this.onFilterChanged();
		};
		
		SearchBar.prototype.onFilterChanged = function() {
			var me = this;
			var w = me.view.width() - me.filters.width() - parseInt(me.view.css("padding-left").replace("px", ""), 10);
			me.input.css({width:w + "px"});
			if (me.filters.find(".filter").length == 0) {
				me.btnClear.hide();
			} else {
				me.btnClear.show();
			}
			core.events.trigger(this, "filter_change");
		};
		
		function Events(view, empty, loading, opts) {
			var me  = this;
			me.viewWidth = 255;
			me.opts = opts;
			me.view = view;
			me.empty = empty;
			me.loading = loading;
			me.userView = me.view.parent().find(".box.user");
			me.years = {};
			me.view.on("click", ".event", function() {
				if(me.opts.onItemClick) {
					me.opts.onItemClick($(this).attr("key"));
				}
			});
			
			me.view.on("click", ".event .label", function(e) {
				core.events.trigger(me, "click_tag", $(this).attr("key"));
				e.stopPropagation();
			});
			
			me.view.on("click", ".event .owner", function(e) {
				core.events.trigger(me, "click_user", $(this).attr("key"));
				e.stopPropagation();
			});
			
			me.view.on("click", ".event .btn-share", function(e) {
				$(this).parent().find(".btn-cancel").show();
				$(this).parent().find(".btn-fb").addClass("show");
				$(this).hide();
				e.stopPropagation();
			});
			
			me.view.on("click", ".event .btn-cancel", function(e) {
				$(this).parent().find(".btn-share").show();
				$(this).parent().find(".btn-fb").removeClass("show");
				$(this).hide();
				e.stopPropagation();
			});
			
			me.view.on("click", ".event .btn-fb", function(e) {
				core.events.trigger(me, "share_to_fb", $(this).parents(".event").attr("key"));
				e.stopPropagation();
			});
		}
		
		Events.prototype.getYear = function(year) {
			var me = this;
			if (!me.years[year]) {
				me.years[year] = new Year(this, year);
			}
			return me.years[year];
		};
		
		Events.prototype.addEvent = function(e) {
			var me = this;
			var event_time = strptime(e.event_time, core.timezone);
			var year = me.getYear(event_time.getFullYear());
			var eventsContainer = year.getEvents();
			var events = eventsContainer.find(".event");
			var view = me.inflateEvent2(e);
			if (events.length == 0) {
				eventsContainer.append(view);
				me.notifyDataChanged();
				return view;
			}

			var added = false;
			events.each(function(i) {
				var time = strptime($(this).attr("time"));
				if (time < event_time) {
					view.insertBefore($(this));
					added = true;
					return false;
				}
			});
			if (!added)
				eventsContainer.append(view);
			me.notifyDataChanged();
			return view;
		};
		
		Events.prototype.updateEvent = function(e) {
			var eventView = this.events.filter(".event[key=" + e.id + "]");
			eventView.html(this.inflateEvent2(e).html());
			this.relayout();
		};
		
		Events.prototype.inflateEvent = function(e) {
			var date = strptime(e.event_time, core.timezone);
			var eventView = $("<div class='event' time='" + date.format(core.DATETIME_FORMAT) + "'></div>");
			eventView.attr("key", e.id);
			eventView.append("<div class='date'><div class='month'>" + date.format("mmm").toUpperCase() + "</div>" + 
							"<div class='day'>" + date.format("d") + "</div></div>")
			if (e.photo)
				eventView.css("background-image", "url(" + e.photo.thumb_url + "300)")
			return eventView;
		};
		
		Events.prototype.inflateEvent2 = function(e) {
			var width = this.viewWidth;
			var date = strptime(e.event_time, core.timezone);
			var eventView = $("<div class='box event' time='" + date.format(core.DATETIME_FORMAT) + "'></div>");
			eventView.attr("key", e.id);
			var photoView = $("<div class='photo up-corner'></div>").appendTo(eventView);
			if (e.photo) {
				var img = $("<img src='" + e.photo.thumb_url + "350' />").appendTo(photoView);
				var h = (1.0 * e.photo.height / e.photo.width) * width;
				img.css( { width: width + "px", height: h + "px"} );
				photoView.append("<div class='date'><div class='month'>" + date.format("mmm").toUpperCase() + "</div>" + 
								"<div class='day'>" + date.format("d") + "</div></div>")
			}
			
			var descView = $("<div class='desc'><span>" + (e.description || "")  + "</span></div>").appendTo(eventView);
			var owner = null;
			if (e.owner.id != core.user.id && e.photo) {
				owner = core.Friend.users[e.owner.id];
				//TODO fetch friends first
				if (owner)
					descView.append("<img class='owner owner-float' key='" + e.owner.id + "' src='" + owner.profile_picture + "' />")
			} else if (!e.photo) {
				descView.addClass("up-corner");
				if (e.owner.id != core.user.id)
					owner = core.Friend.users[e.owner.id];
				else
					owner = core.user;
				descView.prepend("<div><img class='owner' key='" + e.owner.id + "' src='" + owner.profile_picture + "' /></div>")
			}
			
			if (e.place) {
				eventView.append("<div class='place'><span>" + assets.svg.marker + "</span>" +
						"<span class='place-name btn-link'>" + e.place.name + "</span></div>");
			}
			
			if (e.tags.length > 0) {
				eventView.append("<div class='tags'><span></span>" +
						"<div class='labels'><span class='label' key='" + e.tags[0] + "'>" + e.tags[0] + "</span></div></div>");
			}
			
			eventView.append("<div class='event-footer'>" + 
								"<span class='btn-icon btn-share'>" + assets.svg.share + "</span>" + 
								"<span class='btn-icon btn-cancel' style='display:none;'>" + assets.svg.clear + "</span>" + 
								"<span class='btn-icon btn-fb'>" + assets.svg.facebook + "</span>" + 
								"</div>");
				
			return eventView;
		};
		
		Events.prototype.relayout = function() {
			var me = this;
			if (!me.events)
				return;
			var hasUserProfile = !(me.filters && me.filters.length > 0);
			var windowWidth = $(window).width();
			var gapWidth = 30;
			var gapHeight = 30;
			var eventWidth = 255;
			var spanX = parseInt(windowWidth / (eventWidth + gapWidth), 10);
			var lastY = [];
			for (var i = 0; i < spanX; i++)
				lastY.push(0);
			me.view.parent().css({ width:(eventWidth*spanX + gapWidth*(spanX - 1)) + "px"});
			
			if (hasUserProfile) {
				me.userView.show();
				var user = core.user;
				me.userView.css( {top:"0px", left:"0px" } );
				lastY[0] = me.userView.height() + gapHeight;
			} else {
				me.userView.hide();
			}
			
			me.events.each(function(i) {
				if (hasUserProfile) i += 1;
				var cellX = i % spanX;
				var e = $(this);
				e.css({ top:lastY[cellX] + "px", left:(cellX * (eventWidth + gapWidth)) + "px" });
				lastY[cellX] = lastY[cellX] + e.height() + gapHeight;
			});
		};
		
		Events.prototype.notifyDataChanged = function() {
			var me = this;
			me.events = me.view.find(".event");
			if (me.events.length > 0) {
				me.empty.hide();
				me.relayout();
			} else {
				me.empty.show();
			}
		};
		
		Events.prototype.clear = function() {
			var me = this;
			me.view.html("");
			me.years = {};
		};
		
		Events.prototype.fetch = function(filters) {
			var me = this;
			me.userView.hide();
			me.filters = filters;
			me.clear();
			me.loading.show();
			var api = "/events";
			if (filters) {
				var tags = [];
				var users = [];
				for (var i in filters) {
					var f = filters[i];
					if (f.type == "user") {
						users.push(f.key);
					} else if (f.type == "tag") {
						tags.push(f.key);
					}
				}
				var q = "";
				if (tags.length > 0) {
					q += "tags=" + tags.join(",");
				}
				if (users.length > 0) {
					if (q) q += "&";
					q += "u=" + users.join(",");
				}
				if (q) api += ("?" + q);
			}
			core.api(api, "GET", function(res) {
				if (res) {
					if (res.length > 0) {
						var year = null;
						for (var i in res) {
							var e = res[i];
							if (e.location) {
								var marker = core.Map.createMarker({ position:e.location });
								marker.event = e;
								core.Map.markers.push(marker);
							}
							var date = strptime(e.event_time, core.timezone);
							if (!year || date.getFullYear() != year.getYear()) {
								year = me.getYear(date.getFullYear());
							}
							var eventView = me.inflateEvent2(e).appendTo(year.getEvents());
						}
					} 
					me.notifyDataChanged();
				}
				me.loading.hide();
			});
		};
		
		function NotificationCounter(view) {
			this.view = view;
			this.count = this.view.find(".count");
			this.fetch();
			var me = this;
			this.alarm = new Alarm(function() {
				me.fetch();
				me.startListening();
			});
		}
		
		NotificationCounter.prototype.fetch = function() {
			var me = this;
			core.api("/me/messages/count", "GET", function(res) {
				if (res) {
					core.events.trigger(me, "count_changed", res.count);
					if (res.count > 0) {
						me.count.text(res.count);
						me.count.show();
					} else {
						me.count.hide();
					}
				}
			});
		};
		
		NotificationCounter.prototype.startListening = function() {
			this.alarm.cancel();
			this.alarm.start(120000);
		};
		
		NotificationCounter.prototype.stopListening = function() {
			this.alarm.cancel();
		};
		
		function Notifications(view) {
			var me = this;
			this.view = view;
			this.loading = false;
			this.loadingF = this.view.find(".loading-f");
			this.loadingB = this.view.find(".loading-b");
			this.loadmore = this.view.find(".loadmore");
			this.hasMoreF = true;
			this.hasMoreB = true;
			this.btnLoadmore = this.loadmore.find("span").click(function() {
				me.fetch("b");
			});
			this.cursor_f = null;
			this.cursor_b = null;
			this.messages = view.find(".messages");
			this.messages.on("click", ".msg", function() {
				var msgView = $(this);
				core.events.trigger(me, "click_msg_event", $(this).attr("target"));
				core.api("/me/message/" + $(this).attr("key") + "/read", "POST", {}, function() {
					msgView.addClass("read");
				});
			});
		}
		
		Notifications.prototype.mark_as_seen = function(ids) {
			if (ids.length == 0)
				return;
			core.api("/me/messages/seen", "POST", {ids:ids}, function() {
				
			});
		};
		
		Notifications.prototype.notifyNewMessage = function() {
			this.hasMoreF = true;
		};
		
		Notifications.prototype.fetch = function(d) {
			var me = this;
			if (me.loading)
				return;

			if (!d) {
				if (me.messages.find(".msg").length == 0 && me.hasMoreB) {
					d = "b";
				} else if (me.hasMoreF) {
					d = "f";
				} else {
					return;
				}
			}
			
			if (d == "b") {
				me.loadingB.show();
				cursor = this.cursor_b;
			} else if (d == "f") {
				me.loadingF.addClass("play");
				cursor = this.cursor_f;
			}
			me.loading = true;
			me.loadmore.hide();
			core.api("/me/messages?d=" + d + (cursor ? ("&c=" + cursor) : ""), "GET", function(res) {
				if (res) {
					if (d == "b") {
						me.loadingB.hide();
						if (res.cursor_f) {
							me.cursor_f = res.cursor_f;
						}
						me.cursor_b = res.cursor_b;
						me.hasMoreB = res.more;
					} else if (d == "f") {
						me.loadingF.removeClass("play");
						if (res.cursor_f)
							me.cursor_f = res.cursor_f;
						me.hasMoreF = res.more;
					}
					var msgs = res.msgs;
					var seen = [];
					var dayView = null;
					var now = new Date();
					for (var i in msgs) {
						var msg = msgs[i];
						var created_time = strptime(msg.created_time, core.timezone);
						var str_created_time = created_time.format(core.DATE_FORMAT);
						if (dayView == null || dayView.attr("date") != str_created_time) {
							dayView = me.messages.find(".day[date=" + str_created_time + "]");
							if (dayView.length == 0) {
								var label = "";
								if (now.format(core.DATE_FORMAT) === str_created_time) {
									label = "Today";
								} else {
									label = format_time(created_time);
								}
								dayView = $("<div class='day' date='" + str_created_time + "'>" + 
									"<div class='date'>" + 
										label + 
									"</div></div>").appendTo(me.messages);
							}
						}
						var msgView = null;
						var msgViewHeight = 80;
						var msgViewPadding = 10;
						if (msg.msg_type == 2000004 || msg.msg_type == 2000005) {
							var sender = core.Friend.users[msg.user.id];
							msgView = $("<div class='msg event' key='" + msg.id + "' target='" + msg.target.id + "'>" + 
											"<img class='sender-profile-picture' src='" + sender.profile_picture + "' />" +
											"</div>");
							var imgWidth = 0;
							if (msg.target.photo) {
								var imgView = $("<img class='target-photo' src='" + 
												msg.target.photo.thumb_url + "200' />").appendTo(msgView);
								var h = msgViewHeight - (msgViewPadding*2);
								var w = h * (1.0 * msg.target.photo.width/msg.target.photo.height);
								imgView.css({width:w+"px", height:h+"px"});
								imgWidth = w;
							}
							var contentView = $("<div class='content'>" +
								"<div>" + msg.message_str + "</div>" + 
								"<div class='time txt2nd'>" + created_time.format(core.TIME12_FORMAT) + "</div>" + 
								"</div>").appendTo(msgView);
							contentView.css({"margin-right":imgWidth+"px"});
							if (msg.read) {
								msgView.addClass("read");
							}
							if (!msg.seen) {
								seen.push(msg.id);
							}
						}
						if (msgView) {
							if (d == "b") {
								dayView.append(msgView);
							} else if (d == "f") {
								dayView.prepend(msgView);
							}
						}
					}
					if (me.hasMoreB)
						me.loadmore.show();
					me.loading = false;
					me.mark_as_seen(seen);
					/*new Alarm(function() {
						me.messages.find(".msg").addClass("new");
					}).start(100);*/
				}
			});
		};
		
		function SidePanel(view) {
			this.view = view;
			var me = this;
			this.mask = $(".sidepanel-mask").click(function() {
				me.close();
			});
			this.mainView = $("#main");
			this.view.on("mousewheel DOMMouseScroll", function(e) {
				var scrollTo = null;

			    if (e.type == 'mousewheel') {
			        scrollTo = (e.originalEvent.wheelDelta * -1);
			    }
			    else if (e.type == 'DOMMouseScroll') {
			        scrollTo = 40 * e.originalEvent.detail;
			    }

			    if (scrollTo) {
			        e.preventDefault();
			        $(this).scrollTop(scrollTo + $(this).scrollTop());
			    }
			});
			this.messages = new Notifications(this.view.find(".notification"));
			
			this.alarm = new Alarm(function() {
				me.messages.fetch();
			});
		}
		
		SidePanel.prototype.open = function() {
			var me = this;
			this.view.addClass("open");
			this.mask.addClass("show");
			this.mainView.addClass("blur");
			this.alarm.cancel();
			this.alarm.start(300);
		};
		
		SidePanel.prototype.close = function() {
			this.view.removeClass("open");
			this.mask.removeClass("show");
			this.mainView.removeClass("blur");
			this.alarm.cancel();
			core.events.trigger(this, "close");
		};
		
		function Year(p, year) {
			var view = $("<div class='year' year='" + year + "'></div>");
			//view.append("<div class='header'><span class='year-num'>" + year + "</span></div>");
			view.append("<div class='events'></div>");
			if (new Date().getFullYear() == year) {
				view.find(".header").hide();
			}
			var years = p.view.find(".year");
			if (years.length == 0) {
				p.view.append(view);
			} else {
				var added = false;
				years.each(function(i) {
					var currentYear = parseInt($(this).attr('year'), 10);
					if (currentYear < year) {
						view.insertBefore($(this));
						added = true;
						return false;
					}
				});
				if (!added)
					p.view.append(view);
			}
			this.view = view;
			this.year = year;
			this.events = view.find(".events");
		}
		
		Year.prototype.getYear = function() {
			return this.year;
		}
		
		Year.prototype.getEvents = function() {
			return this.events;
		}
		
		function ProgressBar(view) {
			var me = this;
			me.view = view;
			me.progress = me.view.find(".progress");
		}
		
		ProgressBar.prototype.setProgress = function(value) {
			var me = this;
			me.progress.css({ width:value + "%" });
		};
		
		function TagsDialog(view) {
			this.view = view;
			this.content = view.find(".dlg-content");
		}
		
		TagsDialog.prototype.fetch = function() {
			var me = this;
			core.api("/tags", "GET", function(res) {
				if (res) {
					me.content.html("");
					for (var i in res) {
						var tag = res[i];
						me.content.append("<div><span class='tag' key='" + tag.name + "'>" + 
								tag.name + "<span class='tag-event-count'>" + tag.count +"</span></span></div>");
					}
				}
			});
		};
		
		TagsDialog.prototype.show = function() {
			this.view.show();
			this.fetch();
		};
		
		TagsDialog.prototype.hide = function() {
			this.view.hide();
		};
		
		function FriendsDialog(view) {
			this.view = view;
			this.content = view.find(".dlg-content");
		}
		
		FriendsDialog.prototype.show = function() {
			this.view.show();
			this.fetch();
		};
		
		FriendsDialog.prototype.hide = function() {
			this.view.hide();
		};
		
		FriendsDialog.prototype.fetch = function() {
			var me = this;
			core.api("/me/friends", "GET", function(res) {
				if (res) {
					me.content.html("");
					for (var i in res) {
						var user = res[i];
						me.content.append("<div class='user' key='" + user.id + "'>" + 
								"<img src='" + user.profile_picture + "' /><div class='user-name'>" + user.name +"</div</div>");
					}
				}
			});
		};
		
		function DialogEvent(view, opts) {
			var me = this;
			me.opts = opts;
			me.view = view;
			me.editable = me.view.find(".editable");
			me.desc = me.view.find(".dlg-event-desc");
			me.desccontent = me.desc.find(".desc-content");
			me.descbody = me.desc.find(".dlg-event-desc-body");
			me.descbuttons = me.desc.find(".buttons-desc");
			me.date = me.view.find(".btn-date");
			me.time = me.view.find(".btn-time");
			me.btnPhoto = me.view.find(".btn-photo");
			me.btnPlace = me.view.find(".btn-place");
			me.btnPeople = me.view.find(".btn-people");
			me.btnTag = me.view.find(".btn-tag");
			me.photoView = me.view.find(".dlg-event-photo");
			me.placeView = me.view.find(".dlg-event-place");
			me.placeNameView = me.placeView.find(".place-name");
			me.people = me.view.find(".dlg-event-people");
			me.tags = me.view.find(".dlg-event-tags");
			me.filePhoto = me.btnPhoto.find(".file-photo");
			me.mapimage = me.placeView.find("img");
			me.image = me.photoView.find("img");
			me.progressbar = new ProgressBar(me.photoView.find(".progressbar"));
			me.btnPostToFb = me.view.find(".buttons-act .btn-fb");
			me.btnPost = me.view.find(".buttons-act .btn-post");
			me.loading = me.view.find(".dlg-event-loading");
			me.tagPicker = new TagPicker(me.view.find(".menu-tags"));
			me.placePicker = new PlacePicker(me.view.find(".dlg-place-picker"));
			me.loader = new Image();
			me.loader.onload = function() {
				me.image.attr("src", me.loader.src);
				me.image.show();
			};
			
			core.events.bind(me.placePicker, "place_changed", function(place) {
				me.setPlace(place);
			});

			core.events.bind(me.tagPicker, "change", function() {
				var tags = me.tagPicker.getSelected();
				me.setTags(tags);
				if (me.editing) {
					me.update(['tags']);
				}
			});
			
			me.view.click(function() {
				me.dismiss();
			});
			
			me.view.find(".dlg-body")
			.on('dragenter', function(e) {
				me.photoView.show();
				e.stopPropagation();
				e.preventDefault();
			})
			.on('dragover', function(e) {
				e.stopPropagation();
				e.preventDefault();
			})
			.on('dragleave', function(e) {
				e.stopPropagation();
				e.preventDefault();
			})
			.on('drop', function(e) {
				e.stopPropagation();
				e.preventDefault();
				me.handleDropFile(e);
			});
			
			me.desc.find(".dlg-btn-edit").click(function() {
				me.editable.show();
				me.desccontent.hide();
				me.descbuttons.show();
				me.editable.html(me.convertAsEditable(me.descbody.html()));
			});
			
			me.descbuttons.find(".btn-cancel").click(function() {
				me.editable.hide();
				me.desccontent.show();
				me.descbuttons.hide();
			});
			
			me.descbuttons.find(".btn-post").click(function() {
				me.update(["desc"], function(res) {
					if(res) {
						me.editable.hide();
						me.descbody.html(res.description);
						me.desccontent.show();
						me.descbuttons.hide();
						if (me.opts.onEventEdited) {
							me.opts.onEventEdited(res);
						}
					}
				});
			});
			
			me.btnPlace.click(function(show) {
				me.placePicker.show();
			});
			
			me.btnPost.click(function() {
				me.update(["desc", "photo", "event_time", "people", "tags", "loc", "place"], function(res) {
					if(res) {
						me.dismiss();
						if (me.opts.onEventAdded) {
							me.opts.onEventAdded(res);
						}
					}
				});
			});
			
			me.btnPostToFb.click(function() {
				var data = me.prepareData(["desc", "photo"])
				FB.api(
				    "/me/photos",
				    "POST",
				    {
				        "url": me.photo.thumb_url + "1600",
						"privacy" : { value:"SELF"},
						"message" : data.desc
				    },
					function (response) {
						if (response && !response.error) {
						/* handle the result */
							me.dismiss();
						}
					}
				);
			});
			
			me.um = new UploadManager({
				onStart:function() {
					me.photoView.show();
					me.image.hide();
					me.progressbar.view.show();
					me.progressbar.setProgress(0);
					me.btnPost.attr("disabled", "disabled");
				},
				progress:function(file, uploaded, total, percentage) {

				},
				fileprogress:function(i, file, progress) {
					me.progressbar.setProgress(progress);
				},
				uploaded:function(i, file, res) {
					if(res) {
						me.setPhoto(res);
						me.setDate(strptime(res.utc, core.timezone));
						if (res.location) {
							me.setLocation(res.location);
						}
						if (me.editing) {
							me.update(['event_time', 'photo', 'loc']);
						}
					}
				},
				done:function() {
					me.btnPhoto.addClass("active");
					me.btnPost.removeAttr("disabled");
				}
			});
			
			me.filePhoto.change(function() {
				me.uploadPhotoFiles(this.files);
			});
		}
		
		DialogEvent.prototype.convertAsEditable = function(text) {
			return text.replace(/(<[^>]*>)/g, function(match, p1, offset, str) {
								return p1 == "<br>" ? "\n" : "";
							}).replace(new RegExp("\n", "g"), "<br>")
		};
		
		DialogEvent.prototype.handleDropFile = function(e) {
			var files = e.target.files || e.originalEvent.dataTransfer.files;
			this.uploadPhotoFiles(files);
		};
		
		DialogEvent.prototype.prepareData = function(fields) {
			var me = this;
			var data = {};
			for (var i in fields) {
				var f = fields[i];
				switch(f) {
				case 'desc':
					var desc = me.editable.html().trim().replace(/<div>/g, "")
												.replace(/(<br>|<\/div>)/g, "\n")
												.replace(/&amp;/g, "&")
												.replace(/&nbsp;/g, " ")
												.replace(/&lt;/g, "<")
												.replace(/&gt;/g, ">");
					data['desc'] = desc;
					break;
				case 'photo':
					data['pid'] = me.photoView.attr("key");
					break;
				case 'event_time':
					data['event_time'] = me.datetime.format(core.DATETIME_FORMAT);
					break;
				case 'people':
					var people = [];
					var users = me.people.find(".user");
					users.each(function() {
						people.push($(this).attr("key"));
					});
					data['people'] = people;
					break;
				case 'tags':
					var selected_tags = [];
					var tags = me.tags.find(".tag");
					tags.each(function() {
						selected_tags.push($(this).attr("key"));
					});
					data['tags'] = selected_tags;
				case 'loc':
					if (me.loc) {
						data.loc = me.loc;
					}
				case 'place':
					if (me.place) {
						data.place = me.place;
					}
					break;
				}
			}
			return data;
		};
		
		DialogEvent.prototype.update = function(fields, cb) {
			var me = this;

			var data = me.prepareData(fields);
			
			core.api("/event" + ("/" + (me.key || "")), "POST", data, function(res) {
				if(res) {
					if (cb) {
						cb(res);
					}
					
					if (me.key) {
						core.events.trigger(me, "event_changed", res);
					}
				}
			});
		};
		
		DialogEvent.prototype.reset = function() {
			var me = this;
			me.key = null;
			me.loc = null;
			me.place = null;
			me.photo = null;
			me.editing = false;
			me.descbody.html("");
			me.photoView.hide();
			me.placeView.hide();
			me.placePicker.hide();
			me.setPeople([]);
			me.setTags([]);
			me.btnPostToFb.hide();
			me.photoView.attr("key", "");
			me.view.find(".btn-icon").removeClass("active");
			me.loading.hide();
		};
		
		DialogEvent.prototype.loadEvent = function(key) {
			var me = this;
			me.key = key;
			me.loading.show();
			core.api("/event/" + me.key, "GET", function(res) {
				me.loading.hide();
				if (res) {
					me.descbody.html(res.description);
					me.editable.html(me.convertAsEditable(me.descbody.html()));
					me.setDate(strptime(res.event_time, core.timezone));
					if (res.photo)
						me.setPhoto(res.photo);
					if (res.location) {
						me.setLocation(res.location);
					}
					if (res.place) {
						me.setPlace(res.place);
					}
					me.setPeople(res.people);
					me.setTags(res.tags);
				}
			});
		};
		
		DialogEvent.prototype.setMode = function(mode) {
			var me = this;
			me.reset();
			if (mode == 'new') {
				me.editable.html("");
				me.editable.show();
				me.descbuttons.hide();
				me.desccontent.hide();
				me.btnPost.show();
				me.setDate(new Date());
			} else if (mode == 'edit') {
				me.editable.hide();
				me.desccontent.show();
				me.descbuttons.hide();
				me.btnPost.hide();
				me.editing = true;
			} else if (mode == 'fb') {
				me.editable.show();
				me.desccontent.hide();
				me.descbuttons.hide();
				me.btnPost.hide();
				me.btnPostToFb.show();
				FB.login(function(response) {
					me.fb = true;
				}, {scope: 'publish_actions'});
			}
		};
		
		DialogEvent.prototype.setDate = function(date) {
			var me = this;
			me.date.text(date.format("mmm d"));
			me.time.text(date.format("h:MM TT"));
			me.datetime = date.addHours(-core.timezone);
		};
		
		DialogEvent.prototype.setPhoto = function(photo) {
			var me = this;
			me.btnPhoto.addClass("active");
			me.photoView.show();
			me.photo = photo;
			var url = photo.thumb_url + "600";
			if (me.loader.src === url) {
				me.image.attr("src", url);
				me.image.show();
			} else {
				me.loader.src = url;
				me.image.hide();
			}
			me.progressbar.view.hide();
			me.photoView.attr("key", photo.id);
		};
		
		DialogEvent.prototype.setPeople = function(ids) {
			var me = this;
			if (ids.length > 0) {
				me.btnPeople.addClass("active");
				var wrap = $("<div></div>");
				for (var i in ids) {
					var user = core.Friend.lookup(ids[i]);
					wrap.append("<div class='user' key='" + user.id + "'><img src='" + user.profile_picture + "' /></div>");
				}
				me.people.html(wrap.html());
			} else {
				me.btnPeople.removeClass("active");
				me.people.html("");
			}
			
			if (me.editing) {
				me.update(['people']);
			}
		};
		
		DialogEvent.prototype.setTags = function(tags) {
			var me = this;
			me.tags.html("");
			if (tags.length > 0) { 
				me.btnTag.addClass("active");
				for (var i in tags) {
					var tag = tags[i];
					me.tags.append("<span class='tag noselect active' key='" + tag +"'>" + tag + "</span>");
				}
			} else {
				me.btnTag.removeClass("active");
			}
		};
		
		DialogEvent.prototype.setLocation = function(loc) {
			var me = this;
			me.loc = loc;
			me.btnPlace.addClass("active");
			me.placeView.show();			
			/*me.mapimage.show();
			var w = me.placeView.width();
			var h = me.placeView.height();
			var url = "https://maps.googleapis.com/maps/api/staticmap?";
			var q = "center=" + loc.lat + "," + loc.lng + "&zoom=13&size=" + w + "x" + h + "&maptype=roadmap" + 
			"&markers=" + loc.lat + "," + loc.lng;
			me.mapimage.attr("src", url + q);*/
		};
		
		DialogEvent.prototype.setPlace = function(place) {
			var me = this;
			me.place = place;
			me.placeNameView.text(place.name);
			me.btnPlace.addClass("active");
			me.setLocation(place.geometry.location);
			//me.placeView.show();
			if (me.editing) {
				me.update(['loc', 'place']);
			}
		};
		
		DialogEvent.prototype.uploadPhotoFiles = function(files) {
			var me = this;
			me.um.start(files, "/_api/photo");
		};
		
		DialogEvent.prototype.showFromDrop = function(e) {
			var me = this;
			me.setMode('new');
			me.show();
			me.handleDropFile(e);
		};
		
		DialogEvent.prototype.show = function() {
			this.view.show();
		}
		
		DialogEvent.prototype.dismiss = function() {
			this.view.hide();
		}
		
		function PlacePicker(view) {
			this.view = view;
		}
		
		PlacePicker.prototype.init = function() {
			var me = this;
			var mapOptions = {
				center: {lat:0, lng:0},
				zoom: 4,
				mapTypeId: google.maps.MapTypeId.ROADMAP
			};
			var map = new google.maps.Map(this.view.find(".map-canvas")[0], mapOptions);
			map.controls[google.maps.ControlPosition.TOP_LEFT].push(this.view.find(".text-autocomplete")[0]);
			this.map = map;
			this.autocompleteService = new google.maps.places.AutocompleteService();
			this.placeService = new google.maps.places.PlacesService(map);
			this.marker = new google.maps.Marker({position:{lat:0,lng:0}});
			this.input = this.view.find(".text-search-place");
			this.input.keyup(function() {
				me.alarm.cancel();
				me.alarm.start(200);
			});
			this.containerSuggestions = this.view.find(".autocomplete-suggestions");
			this.containerSuggestions.on("click", ".autocomplete-suggestion", function() {
				me.containerSuggestions.html("");
				me.setPlace($(this).attr("place_id"), function(place) {
					me.place = place;
					core.events.trigger(me, "place_changed", place);
				});
			});

			var html;
			me.alarm = new Alarm(function() {
				var pattern = me.input.val().trim();
				if (pattern === "") {
					me.containerSuggestions.html("");
					return;
				}
				me.autocompleteService.getPlacePredictions({ input: pattern }, function(predictions, status) {
					if (status != google.maps.places.PlacesServiceStatus.OK) {
						return;
					}
					html = "";
					for (var i in predictions) {
						var p = predictions[i];
						html += "<div class='autocomplete-suggestion' place_id='" + p.place_id + "'>" + p.description + "</div>";
					}
					me.containerSuggestions.html(html);
					
				});
			});
		};
		
		PlacePicker.prototype.setPlace = function(place_id, callback) {
			var me = this;
			var request = {
				placeId:place_id
			};
			me.placeService.getDetails(request, function(place, status) {
				if (status == google.maps.places.PlacesServiceStatus.OK) {
					me.marker.setPosition(place.geometry.location);
					me.marker.setMap(me.map);
					me.map.panTo(me.marker.getPosition());
					var p = {
						name:place.name,
						place_id:place.place_id,
						geometry:{
							location:{
								lat:place.geometry.location.lat(),
								lng:place.geometry.location.lng()
							}
						},
						formatted_address:place.formatted_address
					};
					if (callback) {
						callback(p);
					}
				}
			});
		};
		
		PlacePicker.prototype.show = function() {
			var me = this;
			if (!me.map) {
				me.init();
			}
			me.view.show();
		};
		
		PlacePicker.prototype.hide = function() {
			this.view.hide();
		};
		
		function TagPicker(view) {
			var me = this;
			this.view = view;
			this.tags = view.find(".tags");
			this.input = view.find("input[type=text]");
			this.btnAdd = view.find(".btn-add");
			this.view.on("before_show", function() {
				me.setTags(core.Tag.tags);
			});
			
			this.tags.on("click", ".tag", function() {
				$(this).toggleClass("active");
			});
			
			this.inputAlarm = new Alarm(function() {
				if (me.input.val().trim() != "") {
					me.btnAdd.addClass("active");
				} else {
					me.btnAdd.removeClass("active");
				}
			});
			this.input.keyup(function(e) {
				me.inputAlarm.cancel();
				me.inputAlarm.start(200);
				if (e.which == 13 && $(this).val().trim() != "") {
					var tag = me.addTag($(this).val());
					tag.addClass("active")
					$(this).val("");
				}
			});
			
			this.view.find(".btn-post").click(function() {
				core.events.trigger(me, "change");
				me.view.hide();
			});
			
			this.view.find(".btn-cancel").click(function() {
				me.view.hide();
			});
		}
		
		TagPicker.prototype.setTags = function(tags) {
			var me = this;
			me.tags.html("");
			for (var i in tags) {
				var tag = tags[i];
				me.tags.append("<span class='tag noselect' key='" + tag +"'>" + tag + "</span>");
			}
		}
		
		TagPicker.prototype.addTag = function(tagname) {
			var me = this;
			var tag = me.tags.find(".tag[key=" + tagname + "]")
			if (tag.length > 0) {
				tag.addClass("active");
			} else {
				tag = $("<span class='tag noselect' key='" + tagname +"'>" + tagname + "</span>");
				me.tags.prepend(tag);	
			}
			return tag;
		}
		
		TagPicker.prototype.setSelected = function(tags) {
			
		}
		
		TagPicker.prototype.getSelected = function() {
			var tags = [];
			var me = this;
			me.tags.find(".tag.active").each(function() {
				tags.push($(this).attr("key"));
			});
			return tags;
		}
		
		$(function() {
			var searchbar = new SearchBar($("#searchbar"));
			
			var dlgEvent = null;
			$(".btn-menu").on("click", function(e) {
				e.stopPropagation();
				var target = $(this).attr("target");
				var menu = $(target);
				if(menu.is(":visible")) {
					$(".menu").hide();
				} else {
					$(".menu").hide();
					menu.trigger("before_show");
					menu.show();
					menu.trigger("show");
				}
			});
			
			$(".menu").each(function(i) {
				$(this).attr("menu-id", "menu-" + i);
				core.Menu.add($(this));
			});
			
			$(".menu").click(function(e) {
				e.stopPropagation();
			});
			
			var tagsDialog = new TagsDialog($("#dlg_tags"));
			var btnTags = $(".box.user .btn-tags").click(function() {
				tagsDialog.show();
			});
			
			var friendsDialog = new FriendsDialog($("#dlg_friends"));
			var btnFriends = $(".box.user .btn-friends").click(function() {
				friendsDialog.show();
			});
			
			var sidepanel = new SidePanel($(".sidepanel"));
			var btnNotice = $(".btn-notice");
			btnNotice.click(function() {
				sidepanel.open();
			});
			
			core.events.bind(sidepanel.messages, "click_msg_event", function(id) {
				dlgEvent.setMode('edit');
				dlgEvent.loadEvent(id);
				dlgEvent.show();
			});
			
			core.events.bind(sidepanel, "close", function() {
				counter.fetch();
			});
			
			var counter = new NotificationCounter(btnNotice);
			core.events.bind(counter, "count_changed", function(count) {
				if (count > 0)
					sidepanel.messages.notifyNewMessage();
			});
			
			var btnAlignTop = $(".btn-align-top").click(function() {
				$("body").animate({
					scrollTop:"0px"
				}, 1000);
			});
			$(window).focus(function() {
				counter.fetch();
				counter.startListening();
			}).blur(function() {
				counter.stopListening();
			}).on("scroll", function() {
				if ($(this).scrollTop() > 200) {
					btnAlignTop.addClass("show");
				} else {
					btnAlignTop.removeClass("show");
				}
			});
			
			var dlgDrop = $("#dlg_drop");
			var droparea = dlgDrop.find(".droparea");
			droparea.on('dragenter', function(e) {
				e.stopPropagation();
				e.preventDefault();
				droparea.addClass("play");
			}).on('dragover', function(e) {
				e.stopPropagation();
				e.preventDefault();
			}).on('dragleave', function(e) {
				e.stopPropagation();
				e.preventDefault();
				droparea.removeClass("play");
			}).on('drop', function(e) {
				e.stopPropagation();
				e.preventDefault();
				dlgDrop.hide();
				droparea.removeClass("play");
				dlgEvent.showFromDrop(e);
			});
			
			dlgDrop.on('dragenter', function(e) {
				e.stopPropagation();
				e.preventDefault();
			}).on('dragover', function(e) {
				e.stopPropagation();
				e.preventDefault();
			}).on('dragleave', function(e) {
				e.stopPropagation();
				e.preventDefault();
				dlgDrop.hide();
				droparea.removeClass("play");
			}).on('drop', function(e) {
				e.stopPropagation();
				e.preventDefault();
				dlgDrop.hide();
				droparea.removeClass("play");
			});
			
			$(document).click(function() {
				$(".menu").hide();
			})
			.on('dragenter', function(e) {
				e.stopPropagation();
				e.preventDefault();
				dlgDrop.show();
			})
			.on('dragover', function(e) {
				e.stopPropagation();
				e.preventDefault();
			})
			.on('dragleave', function(e) {
				e.stopPropagation();
				e.preventDefault();
			})
			.on('drop', function(e) {
				e.stopPropagation();
				e.preventDefault();
			});
			
			var menuPeople = core.Menu.lookup($(".menu-people").attr("menu-id"));
			if (menuPeople) {
				menuPeople.corridor = {
					initial:false,
					loading:false
				};
				menuPeople.people = [];
				menuPeople.viewpeople = menuPeople.view.find(".people");
				menuPeople.view.on("click", ".user", function() {
					$(this).toggleClass("checked");
					var count = menuPeople.getSelected().length;
					menuPeople.btnPost.text("Apply" + (count > 0 ? "(" + count + ")" : ""));
				});
				
				menuPeople.view.find(".btn-cancel").click(function() {
					menuPeople.view.hide();
				});
				
				menuPeople.btnPost = menuPeople.view.find(".btn-post");
				menuPeople.btnPost.click(function() {
					var users = menuPeople.getSelected();
					var ids = [];
					users.each(function(i) {
						ids.push($(this).attr("key"));
					});
					dlgEvent.setPeople(ids);
					menuPeople.view.hide();
				});
				
				menuPeople.getSelected = function() {
					return menuPeople.view.find(".user.checked");
				};
				
				menuPeople.setSelected = function(ids) {
					menuPeople.getSelected().removeClass("checked");
					for (var i in ids) {
						menuPeople.view.find(".user[key=" + ids[i] +"]").addClass("checked");
					}
					var count = ids.length;
					menuPeople.btnPost.text("Apply" + (count > 0 ? "(" + count + ")" : ""));
				};
				
				core.events.bind(menuPeople, "show", function() {
					if (!menuPeople.corridor.initial && !menuPeople.corridor.loading) {
						menuPeople.corridor.loading = true;
						core.api("/me/friends", "GET", function(res) {
							if (res) {
								for (var i in res) {
									var user = res[i];
									core.Friend.add(user);
									menuPeople.viewpeople.append("<div class='user' key='" + user.id + "'>"
												+ "<img src=" + user.profile_picture + " />"
												+ "<div class='mask-check'>" + assets.svg.check + "</div>"
												+ "</div>")
								}
							}
							
							menuPeople.corridor.loading = false;
							menuPeople.corridor.initial = true;
						});
					}
				});
			}
			
			var events = new Events($("#events"), $("#empty"), $("#loading"), {
				onItemClick:function(id) {
					dlgEvent.setMode('edit');
					dlgEvent.loadEvent(id);
					dlgEvent.show();
				}
			});
			
			core.events.bind(events, "click_tag", function(tag) {
				searchbar.clearFilters();
				searchbar.addTag(tag);
				searchbar.notifyFiltersChanged();
			});
			
			core.events.bind(events, "click_user", function(user) {
				searchbar.clearFilters();
				searchbar.addUser(user);
				searchbar.notifyFiltersChanged();
			});
			
			core.events.bind(events, "share_to_fb", function(id) {
				dlgEvent.setMode('fb');
				dlgEvent.loadEvent(id);
				dlgEvent.show();
			});
			
			var alarmRelayout = new Alarm(function() {
				events.relayout();
			});
			$(window).resize(function() {
				alarmRelayout.cancel();
				alarmRelayout.start(400);
			});
			
			dlgEvent = new DialogEvent($("#dlg_event"), {
				onEventAdded:function(event) {
					var view = events.addEvent(event);
					core.Tag.update();
					$("body").animate({
	                        scrollTop: view.offset().top
	                    }, 800,
						function() {
							
						});
				}
			});
			
			core.events.bind(dlgEvent, "event_changed", function(event) {
				events.updateEvent(event);
			});
			
			$(".btn-new").click(function() {
				dlgEvent.setMode('new');
				dlgEvent.show();
			});
			
			events.fetch();
			
			core.events.bind(searchbar, "filter_change", function() {
				events.fetch(searchbar.getFilters());
			});
			
			$(".dlg").on("mousewheel DOMMouseScroll", function(e) {
				var scrollTo = null;

			    if (e.type == 'mousewheel') {
			        scrollTo = (e.originalEvent.wheelDelta * -1);
			    }
			    else if (e.type == 'DOMMouseScroll') {
			        scrollTo = 40 * e.originalEvent.detail;
			    }

			    if (scrollTo) {
			        e.preventDefault();
			        $(this).scrollTop(scrollTo + $(this).scrollTop());
			    }
			}).click(function() {
				$(this).hide();
			}).find(".dlg-body").click(function(e) {
				e.stopPropagation();
			});
			
			$(".btn-map").click(function() {
				$("#dlg_map").show();
				var map = core.getMap($("#map_canvas")[0], {zoom:4, center:{lat:0, lng:0}});
				var markers = core.Map.markers;
				for (var i in markers) {
					var marker = markers[i];
					marker.setMap(map);
				}
				map.mc.clearMarkers();
				map.mc.addMarkers(markers);
				var bounds = core.Map.getBounds(markers);
				map.fitBounds(bounds);
			});
			
			$("#map_canvas").click(function(e) {
				e.stopPropagation();
			});
			
		});
		
		
		window.fbAsyncInit = function() {
		        FB.init({
		          appId      : '{{ facebook_app_id }}',
		          xfbml      : true,
		          version    : 'v2.1'
		        });
		      };

		      (function(d, s, id){
		         var js, fjs = d.getElementsByTagName(s)[0];
		         if (d.getElementById(id)) {return;}
		         js = d.createElement(s); js.id = id;
		         js.src = "//connect.facebook.net/en_US/sdk.js";
		         fjs.parentNode.insertBefore(js, fjs);
		       }(document, 'script', 'facebook-jssdk'));
			   
		</script>
    </head>
    <body>
		<div id="main">
			<div class="buttons-main">
				<div class="buttons-right">
					<button class="btn-map">Map</button>
					<button class="btn-new btn-post">New Event</button>
					<span class="btn-icon btn-notice">
						<span>
							<svg xmlns="http://www.w3.org/2000/svg" version="1.1" width="16" height="16" data-icon="list" data-container-transform="translate(0 1)" viewBox="0 0 16 16">
						  <path d="M0 0v2h2v-2h-2zm4 0v2h12v-2h-12zm-4 4v2h2v-2h-2zm4 0v2h9v-2h-9zm-4 4v2h2v-2h-2zm4 0v2h12v-2h-12zm-4 4v2h2v-2h-2zm4 0v2h11v-2h-11z" transform="translate(0 1)"/>
							</svg>
							<span class="count" style="display:none;">
								99
							</span>
						</span>
					</span>
				</div>
				<div id="searchbar" class="input-text">
					<svg class="icon-search" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" id="Your_Icon" x="0px" y="0px" width="40px" height="40px" viewBox="0 0 100 100" enable-background="new 0 0 100 100" xml:space="preserve">
					<path d="M99.337,89.242L68.052,57.956c4.063-6.057,6.246-13.179,6.246-20.636c0-9.923-3.864-19.252-10.881-26.269  C56.4,4.035,47.072,0.171,37.149,0.171c-9.923,0-19.252,3.864-26.269,10.88C3.864,18.068,0,27.397,0,37.32  s3.864,19.251,10.881,26.268s16.345,10.881,26.269,10.881c7.541,0,14.737-2.234,20.838-6.385l31.255,31.253  c1.055,1.056,2.995,0.826,4.332-0.511l5.252-5.252C100.164,92.237,100.393,90.297,99.337,89.242z M37.149,64.405  c-14.936,0-27.086-12.15-27.086-27.085s12.151-27.086,27.086-27.086c14.935,0,27.085,12.151,27.085,27.086  S52.084,64.405,37.149,64.405z"/>
					</svg>
					<svg style="display:none;" class="icon-clear" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.0" id="Layer_1" x="0px" y="0px" viewBox="0 0 24 24" enable-background="new 0 0 24 24" xml:space="preserve" height="100px" width="100px">
					<g>
						<path d="M12,2C6.5,2,2,6.5,2,12c0,5.5,4.5,10,10,10s10-4.5,10-10C22,6.5,17.5,2,12,2z M16.9,15.5l-1.4,1.4L12,13.4l-3.5,3.5   l-1.4-1.4l3.5-3.5L7.1,8.5l1.4-1.4l3.5,3.5l3.5-3.5l1.4,1.4L13.4,12L16.9,15.5z"/>
					</g>
					</svg>
					<span class="filters"></span><input id="input-search" type="text" placeholder="tag/people/content" autocomplete="off" />
					<span class="btn-add">
						
					</span>
				</div>
			</div>
			<div id="boxes">
				<div class='box user' style="top:0px; left:0px; display:none;">
					<div class='portrait'><img src='{{ user.profile_picture }}' /></div>
					<div class='profile'><h1>{{ user.name }}</h1></div>
					<div class='menu-item'><span class='btn-friends'>FRIENDS</span></div>
					<div class='menu-item'><span class='btn-tags'>TAGS</span></div>
					<div class='menu-item'><a href='/logout'>SIGN OUT</a></div>
				</div>
				<div id="events"></div>
			</div>
			<div id="empty" style="display:none;">
				There is no any event yet. <br /><button class="btn-new btn-post">New Event</button>
			</div>
			<div id="loading" style="display:none;">
				<div class="loading">
					<div class="loading-circle loading-circle-1">
					</div>
					<div class="loading-circle loading-circle-2">
					</div>
					<div class="loading-circle loading-circle-3">
					</div>
				</div>
			</div>
			
		</div>
		<div class="btn-align-top">
			<svg class="icon-align-top" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" x="0px" y="0px" width="100px" height="100px" viewBox="0 0 100 100" enable-background="new 0 0 100 100" xml:space="preserve">
			<g id="Your_Icon">
				<g>
					<polygon points="67.794,60 49.188,34.703 30.584,60   "/>
					<rect x="10" y="15" width="80" height="10"/>
					<rect x="45" y="60" width="8" height="25"/>
				</g>
			</g>
			</svg>
		</div>
		<div class="sidepanel-mask">
		</div>
		<div class="sidepanel">
			<div class="header">
				
			</div>
			<div class="notification">
				<div class="loading-f" style="display:none;">
					<div class="loading">
						<div class="loading-circle loading-circle-1">
						</div>
						<div class="loading-circle loading-circle-2">
						</div>
						<div class="loading-circle loading-circle-3">
						</div>
					</div>
				</div>
				<div class="messages"></div>
				<div class="loadmore">
					<span>
						See More
					</span>
				</div>
				<div class="loading-b" style="display:none;">
					<div class="loading">
						<div class="loading-circle loading-circle-1">
						</div>
						<div class="loading-circle loading-circle-2">
						</div>
						<div class="loading-circle loading-circle-3">
						</div>
					</div>
				</div>
			</div>
		</div>
		<div id="dlg_map" class="dlg" style="display:none;">
			<div id="map_canvas"></div>
		</div>
		<div id="dlg_drop" class="dlg" style="display:none;">
			<div class="droparea">
				<span class="droparea-info">Drop here</span>
			</div>
		</div>
		<div id="dlg_tags" class="dlg" style="display:none;">
			<div class="dlg-body">
				<div class="dlg-header">
					Tags
				</div>
				<div class="dlg-content">
				</div>
			</div>
		</div>
		<div id="dlg_friends" class="dlg" style="display:none;">
			<div class="dlg-body">
				<div class="dlg-header">
					Friends
				</div>
				<div class="dlg-content">
				</div>
			</div>
		</div>
		<div id="dlg_event" class="dlg" style="display:none;">
			<div class="dlg-body">
				<div class="dlg-event-header">
					<span class="btn-date"></span>
					<span class="btn-time"></span>
				</div>
				<div class="dlg-event-photo">
					<img />
					<div class="progressbar"><div class="progress"></div></div>
				</div>
				<div class="dlg-event-desc">
					<div class="editable" contenteditable="plaintext-only">
					</div>
					<div class="buttons-desc">
						<button class="btn-cancel">Cancel</button>
						<button class="btn-post">Save</button>
					</div>
					<div class="desc-content">
						<span class="dlg-event-desc-body"></span>
						<span class="dlg-btn-edit">Edit</span>
					</div>
				</div>
				<div class="dlg-event-people">
				</div>
				<div class="dlg-event-place">
					<div>
						<span class="btn-icon">
							<svg class="icon-marker" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" x="0px" y="0px" width="100px" height="100px" viewBox="0 0 100 100" enable-background="new 0 0 100 100" xml:space="preserve">
							<g id="Layer_7" display="none">
								<path display="inline" d="M84.938,26.044H15.062c-0.547,0-0.998,0.446-0.998,0.997v45.916c0,0.553,0.451,0.999,0.998,0.999h69.875   c0.555,0,0.998-0.446,0.998-0.999V27.041C85.936,26.49,85.492,26.044,84.938,26.044z M83.777,46.589H16.23v-9.98h67.547V46.589z"/>
							</g>
							<g id="Your_Icon" display="none">
								<path display="inline" d="M85.98,37.144c0-10.476-8.258-18.719-18.434-18.719c-8.217,0-15.168,5.661-17.549,13.31   c-2.383-7.648-9.334-13.113-17.551-13.113c-10.178,0-18.428,8.008-18.428,18.488c0,5.288,2.107,9.024,5.498,13.022h-0.049   l30.547,31.442l30.543-31.442h-0.08C83.871,46.134,85.98,42.428,85.98,37.144z"/>
							</g>
							<g id="Layer_6">
								<path d="M50,14.064c-13.23,0-23.957,10.726-23.957,23.957C26.043,51.25,50,85.936,50,85.936S73.957,51.25,73.957,38.021   C73.957,24.79,63.229,14.064,50,14.064z M50,50.497c-6.617,0-11.979-5.359-11.979-11.977c0-6.616,5.361-11.978,11.979-11.978   c6.613,0,11.979,5.362,11.979,11.978C61.979,45.138,56.613,50.497,50,50.497z"/>
							</g>
							<g id="Layer_5" display="none">
								<polygon display="inline" points="85.982,32.037 85.982,14.051 85.982,14.047 67.993,14.047 67.993,14.047 26.013,14.047    26.013,32.037 50.971,32.037 14.018,68.99 30.98,85.953 67.993,48.942 67.993,74.017 85.982,74.017 85.982,32.037  "/>
							</g>
							<g id="Layer_4" display="none">
								<polygon display="inline" points="62.011,14.107 38.022,14.107 54.017,38.097 14.034,38.097 14.034,62.082 54.015,62.082    38.022,86.071 62.011,86.071 86,50.087  "/>
							</g>
							</svg>
						</span>
						<span class="place-name btn-link">
						</span>
					</div>
					<img />
				</div>
				<div class="dlg-event-tags">
				</div>
				<div class="dlg-buttons">
					<div class="buttons-tools">
						<span class="btn-icon btn-photo">
							<form style="display: inline-block;">
								<label>
							<svg class="icon-photo" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" id="Layer_1" x="0px" y="0px" width="100.0px" height="100px" viewBox="0 0 512 512" enable-background="new 0 0 512 512" xml:space="preserve">
							<path d="M480,80v352H32V80H480 M512,48H0v416h512V48L512,48z M448,240l-96-96L224,272l-96-64l-64,96v96h384V240z"/>
							</svg>
								<input class="file-photo" type="file" />
								</label>
							</form>
						</span>
						<span class="btn-icon btn-people btn-menu" target=".menu-people">
							<svg class="icon-people" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" id="Layer_1" x="0px" y="0px" width="100px" height="100px" viewBox="0 0 100 100" enable-background="new 0 0 100 100" xml:space="preserve">
							<g>
								<path d="M78.685,56.269l-0.013-3.177c4.492,0.587,13.649-2.684,13.649-2.684c-3.104-3.174-3.806-6.879-5.844-21.417   C84.44,14.452,71.805,14.588,70.854,14.588S57.267,14.452,55.229,28.99c-2.038,14.538-2.74,18.243-5.843,21.417   c0,0,9.157,3.271,13.649,2.684l-0.013,3.177c-2.305,2.527-5.047,4.457-7.783,6.102c0.896,0.508,1.785,0.999,2.649,1.473   c6.106,3.35,11.874,6.513,11.874,12.85v6.926h28.4c0.975,0,1.765-0.791,1.765-1.766v-7.94   C99.928,66.631,86.677,65.033,78.685,56.269z"/>
							</g>
							<path d="M99.843,73.97v7.94"/>
							<path d="M43.186,57.071L43.186,57.071v-2.551c2.317-2.701,4.064-5.818,5.253-9.45  c0.169-0.519,0.328-1.048,0.474-1.587c1.214-0.623,2.202-2.282,2.424-4.317c0.075-0.677,0.059-1.331-0.035-1.936  c-0.158-1.007-0.531-1.874-1.053-2.472c0.104-1.927,0.108-3.963,0.018-6.109c-0.07-1.669-0.197-3.404-0.388-5.216  c-0.047-0.448-0.107-0.878-0.179-1.295c-1.807-10.416-11.285-11.445-14.886-11.454c-0.144-0.001-2.636-0.001-2.78,0  c-3.601,0.008-13.079,1.038-14.886,11.454c-0.072,0.417-0.132,0.848-0.179,1.295c-0.19,1.812-0.316,3.546-0.388,5.216  c-0.091,2.146-0.087,4.183,0.018,6.109c-0.523,0.598-0.896,1.465-1.052,2.472c-0.095,0.605-0.111,1.259-0.037,1.936  c0.224,2.035,1.21,3.695,2.425,4.317c0.294,1.08,0.633,2.116,1.019,3.112c1.155,2.989,2.723,5.609,4.709,7.925v2.55v0.001  C14.775,66.818,0.084,68.594,0.084,76.692v8.828c0,1.084,0.878,1.964,1.963,1.964h62.753c1.084,0,1.962-0.88,1.962-1.964v-8.828  C66.763,68.594,52.072,66.818,43.186,57.071z"/>
							</svg>
							<div class="menu menu-people">
								<div class="people">
								</div>
								<div class="buttons">
									<button class="btn-cancel">Cancel</button>
									<button class="btn-post">Apply</button>
								</div>
							</div>
						</span>
						<span class="btn-icon btn-place">
							<svg class="icon-marker" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" x="0px" y="0px" width="100px" height="100px" viewBox="0 0 100 100" enable-background="new 0 0 100 100" xml:space="preserve">
							<g id="Layer_7" display="none">
								<path display="inline" d="M84.938,26.044H15.062c-0.547,0-0.998,0.446-0.998,0.997v45.916c0,0.553,0.451,0.999,0.998,0.999h69.875   c0.555,0,0.998-0.446,0.998-0.999V27.041C85.936,26.49,85.492,26.044,84.938,26.044z M83.777,46.589H16.23v-9.98h67.547V46.589z"/>
							</g>
							<g id="Your_Icon" display="none">
								<path display="inline" d="M85.98,37.144c0-10.476-8.258-18.719-18.434-18.719c-8.217,0-15.168,5.661-17.549,13.31   c-2.383-7.648-9.334-13.113-17.551-13.113c-10.178,0-18.428,8.008-18.428,18.488c0,5.288,2.107,9.024,5.498,13.022h-0.049   l30.547,31.442l30.543-31.442h-0.08C83.871,46.134,85.98,42.428,85.98,37.144z"/>
							</g>
							<g id="Layer_6">
								<path d="M50,14.064c-13.23,0-23.957,10.726-23.957,23.957C26.043,51.25,50,85.936,50,85.936S73.957,51.25,73.957,38.021   C73.957,24.79,63.229,14.064,50,14.064z M50,50.497c-6.617,0-11.979-5.359-11.979-11.977c0-6.616,5.361-11.978,11.979-11.978   c6.613,0,11.979,5.362,11.979,11.978C61.979,45.138,56.613,50.497,50,50.497z"/>
							</g>
							<g id="Layer_5" display="none">
								<polygon display="inline" points="85.982,32.037 85.982,14.051 85.982,14.047 67.993,14.047 67.993,14.047 26.013,14.047    26.013,32.037 50.971,32.037 14.018,68.99 30.98,85.953 67.993,48.942 67.993,74.017 85.982,74.017 85.982,32.037  "/>
							</g>
							<g id="Layer_4" display="none">
								<polygon display="inline" points="62.011,14.107 38.022,14.107 54.017,38.097 14.034,38.097 14.034,62.082 54.015,62.082    38.022,86.071 62.011,86.071 86,50.087  "/>
							</g>
							</svg>
						</span>
						<span class="btn-icon btn-tag btn-menu" target=".menu-tags">
						<svg class="icon-tag" xmlns="http://www.w3.org/2000/svg" version="1.1" width="32" height="32" data-icon="tag" viewBox="0 0 32 32">
						  <path d="M.5 0c-.3 0-.5.2-.5.5v11c0 .3.206.706.406.906l19.281 19.281c.14.14.33.182.5.125h.031l11.594-11.594c.005-.011-.004-.02 0-.031.057-.17.015-.36-.125-.5l-19.281-19.281c-.2-.2-.606-.406-.906-.406h-11zm6 4c1.4 0 2.5 1.1 2.5 2.5s-1.1 2.5-2.5 2.5-2.5-1.1-2.5-2.5 1.1-2.5 2.5-2.5z"/>
						</svg>
						<div class="menu menu-tags">
							<div class="input-text">
								<input type="text" autocomplete="off" />
								<span class="btn-add">
									<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" x="0px" y="0px" width="100px" height="100px" viewBox="0 0 100 100" enable-background="new 0 0 100 100" xml:space="preserve">
									<g id="Plus">
										<circle stroke-width="6" stroke-miterlimit="10" cx="50" cy="50" r="47"/>
										<line stroke-width="6" stroke-miterlimit="10" x1="50" y1="19" x2="50" y2="79"/>
										<line stroke-width="6" stroke-miterlimit="10" x1="80" y1="50" x2="20" y2="50"/>
									</g>
									</svg>
								</span>
							</div>
							<div class="tags">
							</div>
							<div class="buttons">
								<button class="btn-cancel">Cancel</button>
								<button class="btn-post">Apply</button>
							</div>
						</div>
						</span>
					</div>
					<div class="buttons-act">
						<button class="btn-post">Done</button>
						<button class="btn-fb">Post to Facebook</button>
					</div>
				</div>
				<div class="dlg-event-loading" style="display:none;"><img src="/static/images/loading.gif" /></div>
				<div class="dlg-place-picker" style="display:none;">
					<div class="map-canvas">
					</div>
					<div class="text-autocomplete">
						<input class="text-search-place map-controls" type="text" autocomplete="off" />
						<div class="autocomplete-suggestions"></div>
					</div>
				</div>
			</div>
		</div>
    </body> 
</html>